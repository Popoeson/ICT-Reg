<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Slip Preview</title>
<style>
  body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#f5f7fa; color:#222; padding:20px; }

  /* Filters above container */
  .filters { display:flex; gap:20px; justify-content:center; margin-bottom:15px; }
  .filters label { font-weight:600; margin-right:5px; }
  .filters select { padding:6px 10px; border-radius:6px; border:1px solid #ccc; font-size:0.95rem; }

  .container { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
  header { text-align:center; margin-bottom:20px; }
  header img { height:60px; vertical-align:middle; }
  header h1 { display:inline-block; margin:0 0 0 10px; font-size:1.8rem; vertical-align:middle; }
  header h2 { margin-top:5px; font-size:1.4rem; font-weight:400; }
  .student-info, .payment-info, .courses-info { border:1px solid #ddd; border-radius:10px; padding:15px; margin-bottom:20px; }
  .student-info { display:flex; gap:20px; align-items:center; }
  .student-info img { width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid #007bff; }
  .student-info div { flex:1; }
  .student-info div p { margin:4px 0; }
  .payment-info p { margin:6px 0; }
  .payment-info .status { font-weight:600; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ddd; padding:8px; text-align:center; }
  th { background:#007bff; color:#fff; }
  .warning { color:#dc3545; font-weight:600; }
  #downloadBtn { display:block; margin:auto; padding:10px 20px; border:none; border-radius:8px; background:#007bff; color:#fff; font-weight:600; cursor:pointer; transition:0.3s; }
  #downloadBtn:disabled { background:#ccc; cursor:not-allowed; }
  footer { text-align:right; font-size:0.9rem; margin-top:10px; }
</style>
</head>
<body>

<!-- FILTERS ABOVE PDF AREA -->
<div class="filters">
  <div>
    <label for="filterLevel">Filter by Level:</label>
    <select id="filterLevel">
      <option value="">All Levels</option>
      <option value="ND1">ND1</option>
      <option value="ND2">ND2</option>
      <option value="HND1">HND1</option>
      <option value="HND2">HND2</option>
    </select>
  </div>
  <div>
    <label for="filterSemester">Filter by Semester:</label>
    <select id="filterSemester">
      <option value="">All Semesters</option>
      <option value="First Semester">First Semester</option>
      <option value="Second Semester">Second Semester</option>
    </select>
  </div>
</div>

<div class="container">
  <header>
    <img src="upload/logo.jpg" alt="Logo">
    <h1>OWU COLLEGE OF MANAGEMENT TECHNOLOGY</h1>
    <h2>EXAMINATION SLIP — 2024/2025</h2>
  </header>

  <div class="student-info">
    <img id="passport" src="https://via.placeholder.com/100" alt="Passport">
    <div>
      <p><strong>Full Name:</strong> <span id="fullName"></span></p>
      <p><strong>Matric No:</strong> <span id="matric"></span></p>
      <p><strong>Department:</strong> <span id="department"></span></p>
      <p><strong>Level:</strong> <span id="level"></span></p>
      <p><strong>Semester:</strong> <span id="semester"></span></p>
    </div>
  </div>

  <div class="payment-info">
    <h3>EXAM FEE PAYMENT</h3>
    <p><strong>Payment Status:</strong> <span id="paymentStatus" class="status"></span></p>
    <p><strong>Amount Paid:</strong> ₦<span id="amountPaid">0</span></p>
    <p><strong>Payment Type:</strong> <span id="paymentType"></span></p>
    <p><strong>Receipt No:</strong> <span id="receiptNos"></span></p>
    <p><strong>Date:</strong> <span id="paymentDates"></span></p>
  </div>

  <div class="courses-info">
    <h3>REGISTERED COURSES</h3>
    <table>
      <thead>
        <tr>
          <th>S/N</th>
          <th>Course Code</th>
          <th>Course Title</th>
          <th>Semester</th>
        </tr>
      </thead>
      <tbody id="coursesTable">
        <tr><td colspan="4">Loading courses...</td></tr>
      </tbody>
    </table>
    <p id="coursesWarning" class="warning"></p>
  </div>

  <button id="downloadBtn" disabled>Download Exam Slip (PDF)</button>

  <footer>
    Printed on: <span id="printDate"></span>
  </footer>
</div>

<!-- jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- html2canvas library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
(async () => {
  const backendURL = "https://ict-reg.onrender.com";
  const studentId = localStorage.getItem("studentId");

  const passportEl = document.getElementById("passport");
  const fullNameEl = document.getElementById("fullName");
  const matricEl = document.getElementById("matric");
  const deptEl = document.getElementById("department");
  const levelEl = document.getElementById("level");
  const semesterEl = document.getElementById("semester");
  const paymentStatusEl = document.getElementById("paymentStatus");
  const amountPaidEl = document.getElementById("amountPaid");
  const paymentTypeEl = document.getElementById("paymentType");
  const receiptNosEl = document.getElementById("receiptNos");
  const paymentDatesEl = document.getElementById("paymentDates");
  const coursesTableEl = document.getElementById("coursesTable");
  const coursesWarningEl = document.getElementById("coursesWarning");
  const downloadBtn = document.getElementById("downloadBtn");
  const printDateEl = document.getElementById("printDate");

  const filterLevelEl = document.getElementById("filterLevel");
  const filterSemesterEl = document.getElementById("filterSemester");

  printDateEl.textContent = new Date().toLocaleDateString();

  let student = null;

  async function loadSlip() {
    let coursesComplete = false;
    let paymentComplete = false;

    try {
      // STUDENT INFO
const studentRes = await fetch(`${backendURL}/api/students/${studentId}`);
const studentData = await studentRes.json();
if (!studentRes.ok || !studentData.success || !studentData.student) throw new Error("Failed to fetch student info");

student = studentData.student;
passportEl.src = student.passport || "https://via.placeholder.com/100";
fullNameEl.textContent = [student.surname, student.firstname, student.middlename].filter(Boolean).join(" ");
matricEl.textContent = student.matricNo || "N/A";
deptEl.textContent = student.department || "N/A";
levelEl.textContent = student.level || "N/A";

// GET FILTER VALUES FIRST — ONLY ONCE
const selectedLevel = filterLevelEl.value;
const selectedSemester = filterSemesterEl.value;

// UPDATE DISPLAYED SEMESTER
if (!selectedSemester) {
  semesterEl.textContent = "All Semesters";
} else {
  semesterEl.textContent = selectedSemester;
}

      // COURSES
      const coursesRes = await fetch(`${backendURL}/api/registered-courses?matric=${encodeURIComponent(student.matricNo)}`);
      const coursesData = await coursesRes.json();
      coursesTableEl.innerHTML = "";

      let courses = [];
      if (coursesRes.ok && coursesData.success && coursesData.data && coursesData.data.length > 0) {
        courses = coursesData.data;

        // FILTER LEVEL
        if (selectedLevel) courses = courses.filter(c => c.level === selectedLevel);

        // FILTER SEMESTER
        let semesterNumber = null;
        if (selectedSemester === "First Semester") semesterNumber = 1;
        else if (selectedSemester === "Second Semester") semesterNumber = 2;
        if (semesterNumber !== null) courses = courses.filter(c => c.semester === semesterNumber);

        if (courses.length > 0) {
          courses.forEach((c, i) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${i + 1}</td>
              <td>${c.courseCode}</td>
              <td>${c.courseTitle}</td>
              <td>${c.semester === 1 ? 'First Semester' : c.semester === 2 ? 'Second Semester' : c.semester}</td>
            `;
            coursesTableEl.appendChild(row);
          });
          coursesComplete = true;
        } else {
          coursesTableEl.innerHTML = "<tr><td colspan='4'>No courses match the filter</td></tr>";
        }
      } else {
        coursesTableEl.innerHTML = "<tr><td colspan='4'>No courses registered</td></tr>";
        coursesWarningEl.textContent = "Courses to be registered for are not complete";
      }

      // PAYMENTS
      const paymentsRes = await fetch(`${backendURL}/api/payments/${encodeURIComponent(student.matricNo)}`);
      const paymentsData = await paymentsRes.json();

      let payments = [];
      if (paymentsRes.ok && paymentsData.success && paymentsData.data && paymentsData.data.length > 0) {
        payments = paymentsData.data;

        if (selectedLevel) payments = payments.filter(p => p.level === selectedLevel);
        if (selectedSemester) payments = payments.filter(p => p.semester === selectedSemester);
      }

      const totalPaid = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
      amountPaidEl.textContent = totalPaid;
      paymentStatusEl.textContent = totalPaid >= 40000 ? "PAID" : "NOT PAID";
      paymentTypeEl.textContent = payments.map(p => p.paymentType).join(", ") || "N/A";
      receiptNosEl.textContent = payments.map(p => p.receiptNo).join(", ") || "N/A";
      paymentDatesEl.textContent = payments.map(p => new Date(p.createdAt).toLocaleDateString()).join(", ") || "N/A";

      paymentComplete = totalPaid >= 40000;
      paymentStatusEl.classList.toggle("warning", !paymentComplete);

      downloadBtn.disabled = !(coursesComplete && paymentComplete);

    } catch (err) {
      console.error("Error loading exam slip:", err);
    }
  }

  // Initial load
  loadSlip();

  // Filters change
  filterLevelEl.addEventListener("change", loadSlip);
  filterSemesterEl.addEventListener("change", loadSlip);

  // DOWNLOAD PDF (Standard A4 Print Layout)
// Helper to convert image URL → Base64
async function getBase64ImageFromUrl(url) {
  const res = await fetch(url);
  const blob = await res.blob();
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
}

downloadBtn.addEventListener("click", async () => {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert("jsPDF library not loaded.");
    return;
  }

  // Convert passport to Base64
  const passportBase64 = await getBase64ImageFromUrl(passportEl.src);

  // Create a hidden A4 print container
  const printArea = document.createElement("div");
  printArea.style.width = "794px";     // A4 width in px @ 96dpi
  printArea.style.minHeight = "1123px"; // A4 height
  printArea.style.padding = "40px";
  printArea.style.fontFamily = "Segoe UI";
  printArea.style.background = "#fff";
  printArea.style.color = "#000";
  printArea.style.position = "absolute";
  printArea.style.top = "-9999px";  // hide off-screen

  // Fill it with clean content
  printArea.innerHTML = `
    <div style="text-align:center;">
      <img src="upload/logo.jpg" style="height:70px;">
      <h2 style="margin:5px 0;">OWU COLLEGE OF MANAGEMENT TECHNOLOGY</h2>
      <h3>EXAMINATION SLIP — 2024/2025</h3>
    </div>

    <hr style="margin:20px 0;">

    <div style="display:flex; gap:20px;">
      <img src="${passportBase64}" style="width:120px;height:120px;border-radius:50%;border:2px solid #007bff;">
      <div>
        <p><strong>Full Name:</strong> ${fullNameEl.textContent}</p>
        <p><strong>Matric No:</strong> ${matricEl.textContent}</p>
        <p><strong>Department:</strong> ${deptEl.textContent}</p>
        <p><strong>Level:</strong> ${levelEl.textContent}</p>
        <p><strong>Semester:</strong> ${semesterEl.textContent}</p>
      </div>
    </div>

    <hr style="margin:20px 0;"> <!-- line after personal info -->

    <h3 style="margin-top:25px;">EXAM FEE PAYMENT</h3>
    <p><strong>Status:</strong> ${paymentStatusEl.textContent}</p>
    <p><strong>Amount Paid:</strong> ₦${amountPaidEl.textContent}</p>
    <p><strong>Payment Type:</strong> ${paymentTypeEl.textContent}</p>
    <p><strong>Receipt No:</strong> ${receiptNosEl.textContent}</p>
    <p><strong>Date:</strong> ${paymentDatesEl.textContent}</p>

<hr style="margin:20px 0;"> <!-- line after Fee -->


    <h3 style="margin-top:25px;">REGISTERED COURSES</h3>
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th style="border:1px solid #666;padding:6px;">S/N</th>
          <th style="border:1px solid #666;padding:6px;">Course Code</th>
          <th style="border:1px solid #666;padding:6px;">Course Title</th>
          <th style="border:1px solid #666;padding:6px;">Semester</th>
        </tr>
      </thead>
      <tbody>
        ${Array.from(coursesTableEl.children).map(row => `
          <tr>
            ${Array.from(row.children).map(td => `
              <td style="border:1px solid #666;padding:6px;">${td.textContent}</td>
            `).join("")}
          </tr>
        `).join("")}
      </tbody>
    </table>

    <p style="margin-top:40px;text-align:right;font-size:12px;">
      Printed on: ${printDateEl.textContent}
    </p>
  `;

  document.body.appendChild(printArea);

  // Convert to PDF
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "pt", "a4");

  await html2canvas(printArea, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 595.28; // A4 pt width
    const imgHeight = canvas.height * imgWidth / canvas.width;
    pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
  });

  pdf.save(`Exam_Slip_${matricEl.textContent}.pdf`);

  // Clean up
  document.body.removeChild(printArea);
});
})();
</script>
</body>
</html>