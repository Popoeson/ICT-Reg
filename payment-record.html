<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Student Payments</title>
<style>
  :root {
    --primary: #007bff;
    --secondary: #6c757d;
    --success: #28a745;
    --danger: #dc3545;
    --bg: #f5f7fa;
    --card: #fff;
    --text-dark: #222;
    --muted: #6c757d;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  body { margin:0; background: var(--bg); color: var(--text-dark); }
  header { background: var(--primary); color:#fff; padding:16px; text-align:center; font-weight:700; font-size:20px; }
  .container { max-width:1200px; margin:20px auto; padding:16px; }

  /* Tabs */
  .tabs { display:flex; gap:12px; margin-bottom:16px; }
  .tab { padding:10px 20px; cursor:pointer; border-radius:8px; background:#eee; transition:0.3s; }
  .tab.active { background:var(--primary); color:#fff; font-weight:600; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }

  /* Card */
  .card { background:var(--card); border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 4px 16px rgba(0,0,0,0.08); border-left:4px solid var(--primary); transition:0.3s; }
  .card:hover { transform: translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,0.1); }
  .card-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; font-weight:600; font-size:16px; }
  .card-body { display:none; margin-top:10px; border-top:1px solid #eee; padding-top:10px; }

  /* Form */
  form { display:flex; flex-direction:column; gap:12px; }
  input, select { padding:10px; border-radius:6px; border:1px solid #ddd; width:100%; font-size:14px; }
  button { padding:10px 14px; border:none; border-radius:8px; cursor:pointer; background:var(--primary); color:#fff; font-weight:600; transition:0.3s; }
  button:hover { background:#0056b3; }

  .flex { display:flex; gap:12px; flex-wrap:wrap; }
  .flex input, .flex select { flex:1; }
  .spinner { display:inline-block; margin-left:6px; }

  /* Badges */
  .badge { display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px; font-weight:600; color:#fff; }
  .badge.type { background: var(--primary); }
  .badge.semester { background: var(--success); }
  .badge.part { background: #17a2b8; }
  .badge.balance { background: #ffc107; color:#000; }
  .badge.full { background: var(--danger); }

.badge.level {
  background: #343a40;
  color: #fff;
}
  /* Responsive */
  @media (max-width: 600px) {
    .flex { flex-direction:column; }
  }

</style>
</head>
<body>
<header>Admin — Student Payments</header>
<div class="container">

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="newPayment">New Payment</div>
    <div class="tab" data-tab="records">Records</div>
  </div>

  <!-- NEW PAYMENT TAB -->
  <div id="newPayment" class="tab-content active">
    <div class="card">
      <h3>Enter Payment</h3>
      <form id="paymentForm">
        <input type="text" id="matric" placeholder="Matric Number" required />

        <div class="flex">
          <input type="text" id="studentName" placeholder="Student Name" readonly />
          <span id="nameSpinner" class="spinner" style="display:none;">⏳</span>
        </div>

        <div class="flex">
          <input type="text" id="department" placeholder="Department" readonly />
          <input type="text" id="level" placeholder="Level" readonly />
          <span id="deptSpinner" class="spinner" style="display:none;">⏳</span>
        </div>

        <input type="text" id="receipt" placeholder="Receipt Number" required />
        <input type="text" id="amount" placeholder="₦ Amount" required />

        <select id="paymentType" required>
          <option value="">Select Payment Type</option>
          <option value="Part Payment">Part Payment</option>
          <option value="Balance Payment">Balance Payment</option>
          <option value="Full Payment">Full Payment</option>
        </select>

        <select id="semester" required>
          <option value="">Select Semester</option>
          <option value="First Semester">First Semester</option>
          <option value="Second Semester">Second Semester</option>
        </select>

        <input type="text" id="paymentId" placeholder="System Payment ID" readonly />
        <button type="submit">Save Payment</button>
      </form>
    </div>
  </div>

    <!-- RECORDS TAB -->
<div id="records" class="tab-content">

  <!-- FILTERS -->
  <div class="card" style="margin-bottom:16px;">
    <h3>Search & Filters</h3>

    <div class="flex">
      <input type="text" id="searchInput" placeholder="Search by Name or Matric Number..." />

      <select id="filterSemester">
        <option value="">All Semesters</option>
        <option value="First Semester">First Semester</option>
        <option value="Second Semester">Second Semester</option>
      </select>

      <select id="filterLevel">
        <option value="">All Levels</option>
        <option value="ND1">ND1</option>
        <option value="ND2">ND2</option>
        <option value="HND1">HND1</option>
        <option value="HND2">HND2</option>
      </select>

      <select id="filterDept">
        <option value="">All Departments</option>
        <option>Computer Science</option>
        <option>Computer Engineering</option>
        <option>Accountancy</option>
        <option>Business Admin</option>
        <option>Estate Management</option>
        <option>Electrical Electronic Engineering</option>
        <option>Office Technology Management</option>
        <option>Science Laboratory Technology</option>
      </select>
    </div>
  </div>

  <div id="recordsContainer">
    <p>Loading records…</p>
  </div>
</div>

</div>

<script>
(() => {
  const backendURL = "https://ict-reg.onrender.com";

  // ===== Tabs =====
  const tabs = document.querySelectorAll(".tab");
  const contents = document.querySelectorAll(".tab-content");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      const target = tab.dataset.tab;
      contents.forEach(c => c.id === target ? c.classList.add("active") : c.classList.remove("active"));
    });
  });

  // ===== Elements =====
  const matricInput = document.getElementById("matric");
  const studentNameInput = document.getElementById("studentName");
  const departmentInput = document.getElementById("department");
  const levelInput = document.getElementById("level");
  const nameSpinner = document.getElementById("nameSpinner");
  const deptSpinner = document.getElementById("deptSpinner");
  const paymentIdInput = document.getElementById("paymentId");
  const amountInput = document.getElementById("amount");
  const paymentForm = document.getElementById("paymentForm");
  const recordsContainer = document.getElementById("recordsContainer");
  const semesterInput = document.getElementById("semester");

  // ===== Generate Payment ID =====
  function generatePaymentId() {
    const randomNum = Math.floor(10000 + Math.random() * 90000);
    return `PAY/EF/${randomNum}`;
  }
  paymentIdInput.value = generatePaymentId();

  // ===== Debounce =====
  function debounce(fn, delay=300){
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(()=> fn(...args), delay); }
  }

  // ===== Fetch student info =====
  async function fetchStudentInfo() {
    const matric = matricInput.value.trim();
    if (!matric) {
      studentNameInput.value = "";
      departmentInput.value = "";
      levelInput.value = "";
      return;
    }

    nameSpinner.style.display = "inline";
    deptSpinner.style.display = "inline";
    studentNameInput.value = "";
    departmentInput.value = "";
    levelInput.value = "";

    try {
      const res = await fetch(`${backendURL}/api/students/matric/${encodeURIComponent(matric)}`);
      if (!res.ok) throw new Error("Student not found");
      const data = await res.json();

      studentNameInput.value = data.studentName || "";
      departmentInput.value = data.department || "";
      levelInput.value = data.level || "";
    } catch (err) {
      console.error(err);
      studentNameInput.value = "";
      departmentInput.value = "";
      levelInput.value = "";
    } finally {
      nameSpinner.style.display = "none";
      deptSpinner.style.display = "none";
    }
  }

  matricInput.addEventListener("input", debounce(fetchStudentInfo, 500));

  // ===== Amount formatting =====
  amountInput.addEventListener("input", () => {
    let val = amountInput.value.replace(/[^0-9]/g, "");
    amountInput.value = val ? `₦${val}` : "";
  });

  // ===== Save Payment =====
  paymentForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      matricNumber: matricInput.value.trim(),
      studentName: studentNameInput.value,
      department: departmentInput.value,
      level: levelInput.value,
      receiptNo: document.getElementById("receipt").value.trim(),
      amount: parseInt(amountInput.value.replace(/\D/g,'')),
      paymentType: document.getElementById("paymentType").value,
      semester: semesterInput.value,
      systemPaymentId: paymentIdInput.value
    };
    try {
      const res = await fetch(`${backendURL}/api/payments`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.message || "Server error");
      alert("Payment recorded successfully!");
      paymentForm.reset();
      paymentIdInput.value = generatePaymentId();
      studentNameInput.value = "";
      departmentInput.value = "";
      levelInput.value = "";
      loadRecords();
    } catch (err) {
      console.error(err);
      alert("Failed to save payment: " + (err.message || "Server error"));
    }
  });

  // ===== Load Payment Records with Search & Filters =====
let allRecords = []; // store original data

async function loadRecords() {
  try {
    const res = await fetch(`${backendURL}/api/payments`);
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.message || "Server error");

    // Group by matric number
    const grouped = {};
    data.data.forEach(p => {
      if (!grouped[p.matricNumber]) grouped[p.matricNumber] = {
        matricNumber: p.matricNumber,
        studentName: p.studentName,
        department: p.department,
        level: p.level,
        payments: []
      };
      grouped[p.matricNumber].payments.push(p);
    });

    allRecords = Object.values(grouped);

    renderRecords();
  } catch (err) {
    console.error(err);
    recordsContainer.innerHTML = "<p>Failed to load payment records.</p>";
  }
}

// ===== APPLY FILTERS =====
function renderRecords() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const semester = document.getElementById("filterSemester").value;
  const level = document.getElementById("filterLevel").value;
  const dept = document.getElementById("filterDept").value;

  const filtered = allRecords.filter(s => {
    const matchSearch =
      s.studentName.toLowerCase().includes(search) ||
      s.matricNumber.toLowerCase().includes(search);

    const matchDept = dept ? s.department === dept : true;
    const matchLevel = level ? s.level === level : true;

    // semester must check inside payment list
    const matchSemester = semester
      ? s.payments.some(p => p.semester === semester)
      : true;

    return matchSearch && matchDept && matchLevel && matchSemester;
  });

  if (filtered.length === 0) {
    recordsContainer.innerHTML = "<p>No records found.</p>";
    return;
  }

  recordsContainer.innerHTML = filtered.map((s, i) => `
    <div class="card">
      <div class="card-header" data-index="${i}">
        <span>${i+1}. ${s.studentName} (${s.matricNumber}) - ${s.department} - ${s.level}</span>
        <span>▼</span>
      </div>
      <div class="card-body">
        ${s.payments.map(p => `
          <p>
            <span class="badge ${p.paymentType === 'Part Payment' ? 'part' :
              p.paymentType === 'Balance Payment' ? 'balance' : 'full'} type">${p.paymentType}</span>
            <span class="badge semester">${p.semester}</span>
            <span class="badge level">Level: ${p.level}</span>
            <br>
            <strong>Receipt:</strong> ${p.receiptNo} |
            <strong>Amount:</strong> ₦${p.amount} |
            <strong>ID:</strong> ${p.systemPaymentId}
          </p>
        `).join("")}
      </div>
    </div>
  `).join("");

  document.querySelectorAll(".card-header").forEach(header => {
    header.addEventListener("click", () => {
      const body = header.nextElementSibling;
      body.style.display = body.style.display === "block" ? "none" : "block";
    });
  });
}

// ===== Filter Triggers =====
document.getElementById("searchInput").addEventListener("input", renderRecords);
document.getElementById("filterSemester").addEventListener("change", renderRecords);
document.getElementById("filterLevel").addEventListener("change", renderRecords);
document.getElementById("filterDept").addEventListener("change", renderRecords);

loadRecords();

})();
</script>
</body>
</html>