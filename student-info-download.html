<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Info Download | ICT Registration Portal</title>

  <style>
    /* -------------------- STYLES -------------------- */
    :root{
      --primary: #007bff;
      --bg: #f5f7fa;
      --card: #fff;
      --muted: #6b7280;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:#111;}

    header{
      background:var(--primary);
      color:#fff;
      padding:14px 18px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    header h1{font-size:1.2rem;margin:0;}
    .header-right{display:flex;gap:8px;align-items:center;width:100%;flex-wrap:wrap;}
    .filters{
      display:flex;
      gap:8px;
      align-items:center;
      background:rgba(255,255,255,0.06);
      padding:8px;
      border-radius:8px;
      flex-wrap:wrap;
      width:100%;
    }
    .filters input,.filters select{
      padding:8px;
      border-radius:6px;
      border:1px solid rgba(0,0,0,0.08);
      font-size:0.95rem;
      background:#fff;
      flex:1;
      min-width:120px;
    }
    .filters button{
      background:#fff;color:var(--primary);
      border:none;padding:8px 10px;
      border-radius:6px;
      cursor:pointer;font-weight:600;
    }
    .filters button:disabled{opacity:0.6;cursor:not-allowed;}

    main{padding:18px;max-width:1200px;margin:18px auto;}
    .meta-row{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;}
    .students-container{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;
    }

    .student-card{
      background:var(--card);
      border-radius:8px;
      padding:10px;
      box-shadow:0 4px 10px rgba(0,0,0,0.06);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      min-height:72px;
    }
    .student-left{display:flex;gap:10px;align-items:center;flex:1;min-width:0}
    .student-left img{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--primary);flex-shrink:0}
    .student-info{overflow:hidden}
    .student-info h3{font-size:0.98rem;margin:0;color:#0b2b53;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .student-info p{margin:0;font-size:0.85rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card-actions{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
    .download-btn{background:var(--primary);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600}
    .download-btn:disabled{opacity:0.6;cursor:not-allowed}
    .small-muted{font-size:0.82rem;color:var(--muted)}

    .pagination{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:16px;flex-wrap:wrap;}
    .page-btn{padding:6px 10px;border-radius:6px;border:1px solid #e6eefc;background:#fff;cursor:pointer;}
    .page-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);}
    .page-info{font-size:0.9rem;color:var(--muted);}

    .empty{padding:28px;text-align:center;color:var(--muted);}

    @media (max-width:640px){
      header{flex-direction:column;align-items:flex-start;}
      .filters{flex-direction:column;align-items:stretch;gap:6px;width:100%;}
      .filters input,.filters select,.filters button{width:100%;}
      .student-card{flex-direction:column;align-items:flex-start;gap:6px;min-height:auto;}
      .student-left{flex-direction:row;gap:8px;align-items:center;width:100%;}
      .student-info h3,.student-info p{white-space:normal;overflow:visible;text-overflow:initial;}
      .card-actions{flex-direction:row;justify-content:space-between;width:100%;}
      .download-btn{padding:6px 8px;font-size:0.9rem;}
    }

    /* hidden print area (keeps styling for snapshot) */
    .print-area { width:794px; padding:24px; background:#fff; color:#000; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    .print-header { text-align:center; margin-bottom:16px; }
    .print-header img { height:70px; display:block; margin:0 auto 6px; }
    .section-title { font-weight:700; color:var(--primary); margin:6px 0; }
    .personal-grid { display:flex; gap:16px; align-items:flex-start; }
    .personal-left img { width:120px; height:120px; object-fit:cover; border-radius:6px; border:2px solid var(--primary); }
    .info-row { margin-bottom:6px; }
    .doc-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; }
    .doc-thumb { border:1px solid #ddd; padding:8px; border-radius:6px; text-align:center; font-size:12px;}
    hr.section-sep { border:0; border-top:1px solid #ddd; margin:16px 0; }
    table.results { width:100%; border-collapse:collapse; margin-top:8px; }
    table.results th, table.results td { border:1px solid #ddd; padding:6px; font-size:12px; }
    table.results th { background:var(--primary); color:#fff; }
  </style>

  <!-- jsPDF + html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <header>
    <h1>Student Info Download</h1>
    <div class="header-right">
      <div class="filters" role="search" aria-label="filters">
        <input id="searchInput" placeholder="Search name or matric" />
        <select id="levelFilter" title="Filter by level">
          <option value="">All Levels</option>
          <option value="ND1">ND1</option>
          <option value="ND2">ND2</option>
          <option value="HND1">HND1</option>
          <option value="HND2">HND2</option>
        </select>
        <select id="deptFilter" title="Filter by department">
          <option value="">All Departments</option>
          <option>Accountancy</option>
          <option>Business Admin</option>
          <option>Computer Science</option>
          <option>Computer Engineering</option>
          <option>Electrical Engineering</option>
          <option>Mass Communication</option>
          <option>Science Lab Tech</option>
          <option>Estate Management</option>
          <option>OTM</option>
        </select>
        <button id="bulkDownloadBtn" disabled>Bulk Download</button>
      </div>
    </div>
  </header>

  <main>
    <div class="meta-row">
      <div class="small-muted" id="countInfo">Loading students…</div>
      <div class="small-muted" id="pageInfo"></div>
    </div>

    <div id="studentsContainer" class="students-container" aria-live="polite"></div>

    <div id="pagination" class="pagination" aria-label="Pagination"></div>
  </main>

  <footer style="text-align:center;padding:14px;background:#fff;border-top:1px solid #eee">
    © 2025 ICT Registration Portal – All Rights Reserved.
  </footer>

<script>
const backendURL = "https://ict-reg.onrender.com";
const PAGE_SIZE = 200;

const studentsContainer = document.getElementById("studentsContainer");
const searchInput = document.getElementById("searchInput");
const levelFilter = document.getElementById("levelFilter");
const deptFilter = document.getElementById("deptFilter");
const bulkDownloadBtn = document.getElementById("bulkDownloadBtn");
const countInfo = document.getElementById("countInfo");
const pageInfo = document.getElementById("pageInfo");
const paginationEl = document.getElementById("pagination");

let allStudents = [];
let filtered = [];
let currentPage = 1;

// ------------------ ADMIN CHECK ------------------
const adminName = localStorage.getItem("adminName");
const adminRole = localStorage.getItem("adminRole");
const adminDepartment = localStorage.getItem("adminDepartment");
if(!adminName||!adminRole) window.location.href="login.html";
const normalizedRole = (adminRole||"").toLowerCase().replace(/\s/g,"");
const isSuperAdmin = normalizedRole==="superadmin";
const isHeadAdmin = normalizedRole==="headadmin";
const isCashier = normalizedRole==="cashier";
if(isCashier){alert("Access Denied");window.location.href="login.html";}

// ------------------ FETCH STUDENTS ------------------
async function fetchStudents(){
  studentsContainer.innerHTML='<div class="empty">Loading students…</div>';
  try{
    const res=await fetch(`${backendURL}/api/students?limit=10000`);
    const payload=await res.json();
    let list=payload.success?payload.data||[]:[];
    list=list.map(s=>{
      const name = s.studentName || [s.surname, s.firstname, s.middlename].filter(Boolean).join(" ");
      return {...s, displayName:(name||"N/A").trim()};
    });
    if(!isSuperAdmin && !isHeadAdmin && adminDepartment){
      list=list.filter(s=>(s.department||"").toLowerCase().trim()===adminDepartment.toLowerCase().trim());
    }
    allStudents=list;
    applyFiltersAndRender();
  }catch(err){
    console.error(err);
    studentsContainer.innerHTML='<div class="empty">Error loading students.</div>';
    countInfo.textContent="Failed to load students";
  }
}

// ------------------ FILTERING & PAGINATION ------------------
function applyFiltersAndRender(){
  const q=(searchInput.value||"").toLowerCase().trim();
  const level=(levelFilter.value||"").trim();
  const dept=(deptFilter.value||"").trim();
  filtered=allStudents.filter(s=>{
    if(level&&(s.level||"")!==level) return false;
    if(dept&&(s.department||"")!==dept) return false;
    if(!q) return true;
    const name=(s.displayName||"").toLowerCase();
    const matric=(s.matricNo||s.matricNumber||"").toLowerCase();
    return name.includes(q)||matric.includes(q);
  });
  const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
  if(currentPage>totalPages) currentPage=totalPages;
  renderPage(currentPage);
}

function renderPage(pageNum){
  paginationEl.innerHTML="";
  studentsContainer.innerHTML="";
  const total=filtered.length;
  const totalPages=Math.max(1,Math.ceil(total/PAGE_SIZE));
  pageNum=Math.max(1,Math.min(pageNum,totalPages));
  currentPage=pageNum;
  const start=(pageNum-1)*PAGE_SIZE;
  const end=Math.min(total,start+PAGE_SIZE);
  const pageItems=filtered.slice(start,end);
  countInfo.textContent=`Showing ${start+1}-${end} of ${total} students`;
  pageInfo.textContent=`Page ${pageNum} of ${totalPages}`;
  if(!pageItems.length){studentsContainer.innerHTML='<div class="empty">No students found.</div>';}
  else{
    const fragment=document.createDocumentFragment();
    pageItems.forEach(s=>{
      const card=document.createElement("div");
      card.className="student-card";
      card.innerHTML=`
        <div class="student-left">
          <img src="${escapeHtml(s.passport||s.photo||'https://via.placeholder.com/60')}" alt="passport" loading="lazy"/>
          <div class="student-info">
            <h3 title="${escapeHtml(s.displayName)}">${escapeHtml(s.displayName)}</h3>
            <p>${escapeHtml(s.department||'N/A')} • ${escapeHtml(s.level||'N/A')}</p>
          </div>
        </div>
        <div class="card-actions">
          <button class="download-btn" data-id="${escapeHtml(s._id||s.id)}">Download</button>
          <div class="small-muted">${escapeHtml(s.matricNo||s.matricNumber||'')}</div>
        </div>
      `;
      fragment.appendChild(card);
    });
    studentsContainer.appendChild(fragment);
    document.querySelectorAll(".download-btn").forEach(btn=>btn.addEventListener("click",(e)=>downloadSingleStudent(btn.dataset.id,btn)));
  }
}

function renderPaginationControls(totalPages,current){
  const createBtn=(label,cls,handler,disabled=false)=>{
    const b=document.createElement("button");
    b.type="button";b.className=`page-btn ${cls||''}`;b.textContent=label;if(disabled)b.disabled=true;b.addEventListener("click",handler);return b;
  };
  paginationEl.appendChild(createBtn("« Prev","",()=>renderPage(current-1),current<=1));
  const delta=2;
  const start=Math.max(1,current-delta);
  const end=Math.min(totalPages,current+delta);
  if(start>1){paginationEl.appendChild(createBtn("1","",()=>renderPage(1))); if(start>2){const dots=document.createElement("span");dots.className="page-info";dots.textContent="…";paginationEl.appendChild(dots);}}
  for(let p=start;p<=end;p++){paginationEl.appendChild(createBtn(p,p===current?"active":"",()=>renderPage(p)));}
  if(end<totalPages){if(end<totalPages-1){const dots=document.createElement("span");dots.className="page-info";dots.textContent="…";paginationEl.appendChild(dots);}
  paginationEl.appendChild(createBtn(totalPages,"",()=>renderPage(totalPages)));}
  paginationEl.appendChild(createBtn("Next »","",()=>renderPage(current+1),current>=totalPages));
}

// ------------------ UTILITY ------------------
function escapeHtml(str=""){ return String(str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
async function toDataURL(url) {
  try {
    const res = await fetch(url, { mode: 'cors' });
    const blob = await res.blob();
    return await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  } catch (err) {
    console.warn("Image fetch failed:", url, err);
    return null;
  }
}
async function fetchOlevelImages(matricNumber) {
  let olevelImages = [];
  if (!matricNumber) return olevelImages;
  try {
    const res = await fetch(`${backendURL}/api/olevel/${encodeURIComponent(matricNumber)}`);
    if (!res.ok) return olevelImages;
    const data = await res.json();
    if (data.success && Array.isArray(data.record)) {
      olevelImages = data.record
        .flatMap(r => r.olevelData.map(d => d.fileUrl))
        .filter(url => url && url !== "N/A");
    }
  } catch (err) {
    console.error("Error fetching O'Level images:", err);
  }
  return olevelImages;
}

// ------------------ SINGLE DOWNLOAD ------------------
async function downloadSingleStudent(studentId, btnEl) {
  try {
    btnEl.disabled = true;
    btnEl.textContent = "Generating PDF…";

    // Fetch student
    const sRes = await fetch(`${backendURL}/api/students/${encodeURIComponent(studentId)}`);
    const sJson = await sRes.json();
    if (!sJson.success || !sJson.student) throw new Error("Student not found");
    const student = sJson.student;

    // Fetch documents, O'Level, results (same as before)
    let docData = { files: {}, oLevelData: [] };
    try {
      const dRes = await fetch(`${backendURL}/api/documents/${encodeURIComponent(student._id)}`);
      docData = (await dRes.json()).data || docData;
    } catch {}

    const olevelImages = await fetchOlevelImages(student.matricNo || student.matricNumber);

    const passportBase64 = student.passport ? await toDataURL(student.passport) : null;
    const fileBase64Map = {};
    for (const [k, v] of Object.entries(docData.files || {})) { fileBase64Map[k] = v ? await toDataURL(v) : null; }
    const olevelBase64 = [];
    for (const url of olevelImages) {
      const b64 = await toDataURL(url);
      if (b64) olevelBase64.push(b64);
    }

    let results = [];
    try {
      const rRes = await fetch(`${backendURL}/api/results?matricNo=${encodeURIComponent(student.matricNo || student.matricNumber || "")}`);
      const rJson = await rRes.json();
      results = rJson.results || [];
    } catch (e) { console.warn("Results fetch failed", e); }

    // Build print area (same as before)
    const printArea = document.createElement("div");
    printArea.className = "print-area";
    printArea.style.position = "absolute";
    printArea.style.left = "-9999px";
    printArea.style.top = "-9999px";
    document.body.appendChild(printArea);

    const verifiedText = student.verified ? "Verified ✔" : "Not Verified ✘";
    const fullName = [student.surname, student.firstname, student.middlename].filter(Boolean).join(" ") || (student.displayName || "N/A");

    // Build O'Level & document HTML
    const olevelDetailsHtml = (docData.oLevelData && docData.oLevelData.length)
      ? docData.oLevelData.map(o => `<div style="margin-bottom:8px;font-size:13px"><strong>${o.examType || 'O Level'}</strong><div>Serial: ${o.serialNumber || 'N/A'}</div><div>Pin: ${o.pin || 'N/A'}</div></div>`).join("")
      : `<div class="no-file">No O'Level record found</div>`;
    const olevelImagesHtml = olevelBase64.length
      ? olevelBase64.map(b64 => `<img src="${b64}" style="width:120px;height:90px;margin:4px;object-fit:cover;">`).join("")
      : "No O'Level uploaded";

    const docThumbsHtml = Object.entries(fileBase64Map).map(([k,v]) => {
      return `<div class="doc-thumb"><div style="height:90px;overflow:hidden">${v?`<img src="${v}" style="width:100%;height:90px;object-fit:cover;border-radius:4px">`:"No preview"}</div><div style="margin-top:6px;font-size:12px">${k}</div></div>`;
    }).join("") || '<div class="no-file">No documents uploaded</div>';

    const resultsRows = (results && results.length) ? results.map(r => `<tr><td>${escapeHtml(r.courseCode||"")}</td><td>${escapeHtml(r.courseTitle||"")}</td><td>${escapeHtml(r.level||"")}</td><td>${escapeHtml(r.semester||"")}</td><td>${r.score ?? ""}</td><td>${r.grade ?? ""}</td></tr>`).join("") : `<tr><td colspan="6" style="text-align:center;color:#777">No results found</td></tr>`;

    // Entire HTML content
    printArea.innerHTML = `
      <!-- header, personal info, documents, O'Level, JAMB, results (same as your current HTML) -->
     <div class="print-header">
    <img src="upload/logo.jpg" alt="Logo" onerror="this.style.display='none'">
    <div style="font-weight:800;font-size:18px;margin-top:6px;">OWU COLLEGE OF MANAGEMENT TECHNOLOGY</div>
    <div style="font-size:14px;margin-top:4px;">Student Information</div>
    <div style="margin-top:6px;font-size:12px;color:${student.verified ? 'green':'#777'}">${verifiedText}</div>
  </div>
  <hr class="section-sep">
  <div>
    <!-- Personal info -->
    <div>  
        <div style="font-weight:700;margin-bottom:6px;">Personal Information</div>  
        <div class="personal-grid">  
          <div class="personal-left">  
            ${passportBase64 ? `<img src="${passportBase64}" alt="passport">` : `<div style="width:120px;height:120px;background:#f1f1f1;display:flex;align-items:center;justify-content:center;color:#777;border-radius:6px">No Photo</div>`}  
          </div>  
          <div class="personal-right" style="flex:1">  
            <div class="info-row"><strong>Full Name:</strong> ${escapeHtml(fullName)}</div>  
            <div class="info-row"><strong>Matric Number:</strong> ${escapeHtml(student.matricNo || student.matricNumber || "N/A")}</div>  
            <div class="info-row"><strong>Department:</strong> ${escapeHtml(student.department || "N/A")}</div>  
            <div class="info-row"><strong>Level:</strong> ${escapeHtml(student.level || "N/A")}</div>  
            <div class="info-row"><strong>Email:</strong> ${escapeHtml(student.email || "N/A")}</div>  
            <div class="info-row"><strong>Phone:</strong> ${escapeHtml(student.phone || "N/A")}</div>  
            <div class="info-row"><strong>D.O.B:</strong> ${escapeHtml(student.dob || "N/A")}</div>  
            <div class="info-row"><strong>State of Origin:</strong> ${escapeHtml(student.stateOrigin || "N/A")}</div>  
            <div class="info-row"><strong>LGA of Origin:</strong> ${escapeHtml(student.lgaOrigin || "N/A")}</div>  
            <div class="info-row"><strong>Address:</strong> ${escapeHtml(student.address || "N/A")}</div>  
          </div>  
        </div>  
        <hr class="section-sep">  
        <div style="font-weight:700;margin-bottom:6px;">Next of Kin</div>  
        <div class="info-row"><strong>Name:</strong> ${escapeHtml([student.nokSurname, student.nokFirstname].filter(Boolean).join(" ") || "N/A")}</div>  
        <div class="info-row"><strong>Relation:</strong> ${escapeHtml(student.nokRelation || "N/A")}</div>  
        <div class="info-row"><strong>Phone:</strong> ${escapeHtml(student.nokPhone || "N/A")}</div>  
        <div class="info-row"><strong>Address:</strong> ${escapeHtml(student.nokAddress || "N/A")}</div>  
    <hr class="section-sep">

    <!-- Documents -->
    <div style="font-weight:700;margin-bottom:6px;">Documents</div>
    <div class="doc-grid">${docThumbsHtml}</div>

    <!-- O'Level -->
    <div style="margin-top:12px"><strong>O'Level Details & Images</strong>
      ${olevelDetailsHtml}
      <div style="display:flex;flex-wrap:wrap;margin-top:6px">${olevelImagesHtml}</div>
    </div>

    <!-- JAMB -->
    <div style="font-size:12px;margin-top:8px;color:#444">
      JAMB Info: Reg No: ${escapeHtml(docData.jambInfo?.jambRegNo || 'N/A')} — Score: ${escapeHtml(docData.jambInfo?.jambScore || 'N/A')}
    </div>

    <!-- Results -->
    <hr class="section-sep">
    <div style="font-weight:700;margin-bottom:6px;">Results</div>
    <div style="overflow:auto">
      <table class="results">
        <thead>
          <tr>
            <th>Course Code</th><th>Course Title</th><th>Level</th><th>Semester</th><th>Score</th><th>Grade</th>
          </tr>
        </thead>
        <tbody>
          ${resultsRows}
        </tbody>
      </table>
    </div>
  </div>
`;

     document.body.appendChild(printArea);

    // ------------------ PDF Generation (Option A: jsPDF layout + clickable images) ------------------
const { jsPDF } = window.jspdf;
const pdf = new jsPDF("p", "pt", "a4");
const pageWidth = pdf.internal.pageSize.getWidth();
const pageHeight = pdf.internal.pageSize.getHeight();
const margin = 28;
const contentWidth = pageWidth - margin * 2;

let y = margin;

// small helpers
function addPageAndHeader() {
  if (pdf.internal.getNumberOfPages() > 0) pdf.addPage();
  y = margin;
  drawHeader();
}
function drawHeader() {
  // Draw school name + subheading centered
  pdf.setFontSize(14);
  pdf.setFont("helvetica", "bold");
  pdf.text("OWU COLLEGE OF MANAGEMENT TECHNOLOGY", pageWidth / 2, y + 5, { align: "center" });
  pdf.setFontSize(10);
  pdf.setFont("helvetica", "normal");
  pdf.text("Student Information", pageWidth / 2, y + 22, { align: "center" });
  pdf.setFontSize(9);
  const verifiedTextSmall = student.verified ? "Verified ✔" : "Not Verified ✘";
  pdf.text(verifiedTextSmall, pageWidth / 2, y + 36, { align: "center" });
  y += 46;
  // separator line
  pdf.setDrawColor(200);
  pdf.setLineWidth(0.5);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 10;
}

// layout sizes
const passportW = 110;
const passportH = 110;
const smallGap = 8;
const labelW = 120;
const infoLineHeight = 14;
const docThumbW = 110;
const docThumbH = 82;

// Start pdf with header on first page
drawHeader();

// --- PERSONAL INFO ---
function ensureSpace(h) {
  if (y + h > pageHeight - margin) {
    addPageAndHeader();
  }
}

// personal info block: passport + fields
ensureSpace(passportH + 10);
const leftX = margin;
const rightX = margin + passportW + smallGap;

// passport image
if (passportBase64) {
  try {
    pdf.addImage(passportBase64, "PNG", leftX, y, passportW, passportH);
    // add clickable link if original URL present
    if (student.passport && student.passport.startsWith("http")) {
      pdf.link(leftX, y, passportW, passportH, { url: student.passport });
    }
  } catch (e) {
    // fallback: nothing
  }
} else {
  // draw placeholder rectangle
  pdf.setDrawColor(200);
  pdf.rect(leftX, y, passportW, passportH);
  pdf.setFontSize(9);
  pdf.text("No Photo", leftX + passportW / 2, y + passportH / 2, { align: "center", baseline: "middle" });
}

// details on right column
pdf.setFontSize(10);
pdf.setFont("helvetica", "bold");
pdf.text("Full Name:", rightX, y + 12);
pdf.setFont("helvetica", "normal");
pdf.text(`${fullName}`, rightX + labelW - 20, y + 12);

const infoFields = [
  ["Matric Number:", student.matricNo || student.matricNumber || "N/A"],
  ["Department:", student.department || "N/A"],
  ["Level:", student.level || "N/A"],
  ["Email:", student.email || "N/A"],
  ["Phone:", student.phone || "N/A"],
  ["D.O.B:", student.dob || "N/A"],
  ["State of Origin:", student.stateOrigin || "N/A"],
  ["LGA of Origin:", student.lgaOrigin || "N/A"],
  ["Address:", student.address || "N/A"]
];

let curY = y + infoLineHeight + 4;
pdf.setFontSize(9);
for (let i = 0; i < infoFields.length; i++) {
  const [label, val] = infoFields[i];
  ensureSpace(infoLineHeight);
  pdf.setFont("helvetica", "bold");
  pdf.text(label, rightX, curY);
  pdf.setFont("helvetica", "normal");
  // wrap long values within remaining width
  const wrapped = pdf.splitTextToSize(String(val), contentWidth - (passportW + smallGap) - 10);
  pdf.text(wrapped, rightX + labelW - 20, curY);
  curY += wrapped.length * 10 + 2;
}
y = Math.max(y + passportH, curY) + 10;

// Next of Kin block
ensureSpace(60);
pdf.setFont("helvetica", "bold"); pdf.setFontSize(10);
pdf.text("Next of Kin", margin, y);
y += 14;
pdf.setFontSize(9);
pdf.setFont("helvetica", "normal");
pdf.text(`Name: ${( [student.nokSurname, student.nokFirstname].filter(Boolean).join(" ") || "N/A")}`, margin, y);
y += 12;
pdf.text(`Relation: ${student.nokRelation || "N/A"}`, margin, y);
y += 12;
pdf.text(`Phone: ${student.nokPhone || "N/A"}`, margin, y);
y += 12;
pdf.text(`Address: ${student.nokAddress || "N/A"}`, margin, y);
y += 14;

// separator
ensureSpace(20);
pdf.setDrawColor(200);
pdf.setLineWidth(0.5);
pdf.line(margin, y, pageWidth - margin, y);
y += 12;

// --- DOCUMENTS THUMBS ---
pdf.setFont("helvetica", "bold");
pdf.setFontSize(10);
pdf.text("Documents", margin, y);
y += 12;
pdf.setFont("helvetica", "normal");
const docsPerRow = Math.floor((contentWidth + smallGap) / (docThumbW + smallGap));
let docIndex = 0;
let rowX = margin;
let rowTop = y;
for (const [k, b64] of Object.entries(fileBase64Map)) {
  ensureSpace(docThumbH + 30); // thumb plus label
  if (docIndex > 0 && (docIndex % docsPerRow) === 0) {
    // move to next row
    rowTop += docThumbH + 30;
    rowX = margin;
    // if next row would overflow, new page
    ensureSpace((rowTop - y) + docThumbH + 30);
  }
  // draw thumb box
  if (b64) {
    try {
      pdf.addImage(b64, "PNG", rowX, rowTop, docThumbW, docThumbH);
      // clickable link if original URL exists
      const originalUrl = fileUrlMap[k];
      if (originalUrl && originalUrl.startsWith("http")) {
        pdf.link(rowX, rowTop, docThumbW, docThumbH, { url: originalUrl });
      }
    } catch (e) {
      // ignore
    }
  } else {
    pdf.setDrawColor(200);
    pdf.rect(rowX, rowTop, docThumbW, docThumbH);
    pdf.setFontSize(9);
    pdf.text("No preview", rowX + docThumbW / 2, rowTop + docThumbH / 2, { align: "center", baseline: "middle" });
  }
  // label under thumb
  pdf.setFontSize(9);
  pdf.text(String(k), rowX, rowTop + docThumbH + 12, { maxWidth: docThumbW });
  rowX += docThumbW + smallGap;
  docIndex++;
}
y = rowTop + docThumbH + 30;

// --- O'LEVEL DETAILS & IMAGES ---
ensureSpace(30);
pdf.setFont("helvetica", "bold");
pdf.setFontSize(10);
pdf.text("O'Level Details & Images", margin, y);
y += 14;
pdf.setFontSize(9);
pdf.setFont("helvetica", "normal");

// show O'Level textual details
if (docData.oLevelData && docData.oLevelData.length) {
  docData.oLevelData.forEach(o => {
    ensureSpace(36);
    pdf.text(`${o.examType || "O Level"} — Serial: ${o.serialNumber || "N/A"} — Pin: ${o.pin || "N/A"}`, margin, y);
    y += 12;
  });
} else {
  pdf.text("No O'Level record found", margin, y);
  y += 12;
}

// O'Level images row(s)
y += 6;
const olePerRow = Math.floor((contentWidth + smallGap) / (docThumbW + smallGap));
let oleX = margin;
let oleTop = y;
for (let i = 0; i < olevelBase64.length; i++) {
  ensureSpace(docThumbH + 18);
  if (i > 0 && (i % olePerRow) === 0) {
    oleTop += docThumbH + 18;
    oleX = margin;
    ensureSpace((oleTop - y) + docThumbH + 18);
  }
  const b64 = olevelBase64[i];
  const url = olevelUrlMap[i];
  if (b64) {
    try {
      pdf.addImage(b64, "PNG", oleX, oleTop, docThumbW, docThumbH);
      if (url && url.startsWith("http")) pdf.link(oleX, oleTop, docThumbW, docThumbH, { url });
    } catch (e) {}
  } else {
    pdf.setDrawColor(200);
    pdf.rect(oleX, oleTop, docThumbW, docThumbH);
    pdf.text("No preview", oleX + docThumbW / 2, oleTop + docThumbH / 2, { align: "center", baseline: "middle" });
  }
  oleX += docThumbW + smallGap;
}
y = oleTop + docThumbH + 18;

// --- JAMB INFO ---
ensureSpace(24);
pdf.setFontSize(9);
pdf.text(`JAMB Info: Reg No: ${escapeHtml(docData.jambInfo?.jambRegNo || 'N/A')} — Score: ${escapeHtml(docData.jambInfo?.jambScore || 'N/A')}`, margin, y);
y += 18;

// separator before results
ensureSpace(18);
pdf.setDrawColor(200);
pdf.setLineWidth(0.5);
pdf.line(margin, y, pageWidth - margin, y);
y += 12;

// --- RESULTS TABLE ---
const tableX = margin;
const tableW = contentWidth;
const colWidths = [80, 180, 50, 50, 50, 50]; // adjust to contentWidth if needed
// normalize widths to tableW
const totalCols = colWidths.reduce((a,b)=>a+b,0);
const scale = tableW/totalCols;
for (let i=0;i<colWidths.length;i++) colWidths[i] = colWidths[i]*scale;

function drawTableHeader() {
  ensureSpace(24);
  pdf.setFont("helvetica", "bold"); pdf.setFontSize(9);
  let cx = tableX;
  const headers = ["Course Code","Course Title","Level","Semester","Score","Grade"];
  for (let i=0;i<headers.length;i++){
    pdf.text(headers[i], cx + 4, y + 10);
    cx += colWidths[i];
  }
  y += 18;
  pdf.setDrawColor(220); pdf.setLineWidth(0.4);
  pdf.line(tableX, y-8, tableX + tableW, y-8);
  pdf.setFont("helvetica", "normal");
}

drawTableHeader();

const rowHeight = 14;
for (let i=0;i<results.length;i++){
  const r = results[i];
  // if not enough space for row, add new page and redraw header
  if (y + rowHeight > pageHeight - margin) {
    addPageAndHeader();
    drawTableHeader();
  }
  let cx = tableX;
  const cells = [
    r.courseCode || "",
    r.courseTitle || "",
    r.level || "",
    r.semester || "",
    (r.score==null?"":String(r.score)),
    r.grade || ""
  ];
  pdf.setFontSize(9);
  for (let c=0;c<cells.length;c++){
    // wrap cell text if long
    const txt = String(cells[c]);
    const wrapped = pdf.splitTextToSize(txt, colWidths[c]-6);
    pdf.text(wrapped, cx + 4, y + 10);
    cx += colWidths[c];
  }
  y += Math.max(rowHeight, (pdf.splitTextToSize(String(cells[1]), colWidths[1]-6).length * 10) + 4);
}

// If there were zero results, show fallback message
if (!results.length) {
  ensureSpace(24);
  pdf.setFontSize(9);
  pdf.text("No results found", tableX + 4, y);
  y += 18;
}

// Save PDF
const outName = `student_${(student.matricNo || student._id || "student").replace(/\s+/g,'_')}.pdf`;
pdf.save(outName);

    // Cleanup
    document.body.removeChild(printArea);
    btnEl.disabled = false;
    btnEl.textContent = "Download";

  } catch(err) {
    console.error(err);
    alert("PDF generation failed: " + (err.message || ""));
    btnEl.disabled = false;
    btnEl.textContent = "Download";
  }
}

// ------------------ EVENT LISTENERS ------------------
searchInput.addEventListener("input",()=>{currentPage=1;applyFiltersAndRender();});
levelFilter.addEventListener("change",()=>{currentPage=1;applyFiltersAndRender();});
deptFilter.addEventListener("change",()=>{currentPage=1;applyFiltersAndRender();});

// ------------------ INITIAL FETCH ------------------
fetchStudents();
</script>
</body>
</html>