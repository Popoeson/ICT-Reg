<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Information PDF</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      background: #f2f2f2;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .container {
      width: 750px;
      margin: auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin: 0;
      font-size: 22px;
    }
    .section-title {
      font-size: 20px;
      margin-top: 25px;
      border-bottom: 2px solid #000;
      padding-bottom: 5px;
    }
    .label {
      font-weight: bold;
    }
    .passport {
      width: 120px;
      height: 130px;
      object-fit: cover;
      border: 2px solid #333;
    }
  </style>
</head>

<body>

<div class="container" id="pdfContent">

  <!-- HEADER -->
  <div style="text-align:center; margin-bottom:20px;">
    <img id="schoolLogo" src="" alt="School Logo" style="width:100px; height:100px; object-fit:contain;">
    <h2 id="schoolName"></h2>
    <h3>STUDENT INFORMATION</h3>

    <div id="verifyStatus" style="font-size:18px; margin-top:8px;"></div>
  </div>

  <!-- PERSONAL INFORMATION -->
  <h3 class="section-title">Personal Information</h3>
  <div style="display:flex; gap:20px;">
    <img id="passport" class="passport" src="">
    <div>
      <p><span class="label">Full Name:</span> <span id="fullName"></span></p>
      <p><span class="label">Matric Number:</span> <span id="matricNo"></span></p>
      <p><span class="label">Department:</span> <span id="department"></span></p>
      <p><span class="label">Level:</span> <span id="level"></span></p>
      <p><span class="label">Email:</span> <span id="email"></span></p>
      <p><span class="label">Phone:</span> <span id="phone"></span></p>
      <p><span class="label">State of Origin:</span> <span id="stateOrigin"></span></p>
      <p><span class="label">Address:</span> <span id="address"></span></p>
    </div>
  </div>

  <!-- NEXT OF KIN -->
  <h3 class="section-title">Next of Kin</h3>
  <p><span class="label">Name:</span> <span id="nokName"></span></p>
  <p><span class="label">Phone:</span> <span id="nokPhone"></span></p>
  <p><span class="label">Relationship:</span> <span id="nokRelation"></span></p>
  <p><span class="label">Address:</span> <span id="nokAddress"></span></p>

  <!-- DOCUMENTS -->
  <h3 class="section-title">Documents</h3>
  <div id="documentsList"></div>

  <!-- OLEVEL IMAGES -->
  <h3 class="section-title">O'Level Result Images</h3>
  <div id="olevelImages"></div>

  <!-- RESULTS SECTION -->
  <h3 class="section-title">Results</h3>
  <div id="resultsList"></div>

</div>

<button onclick="downloadPDF()" style="margin-top:20px; padding:10px 20px;">Download PDF</button>


<script>
const backendURL = "https://ict-reg.onrender.com";

// ========== FETCH STUDENT ==========
async function loadStudent() {
  const urlParams = new URLSearchParams(window.location.search);
  const matric = urlParams.get("matric");

  const res = await fetch(`${backendURL}/api/students/matric/${matric}`);
  const data = await res.json();

  if (!data.success) {
    alert("Student not found");
    return;
  }
  const student = data.student;

  // ========== HEADER ==========
  document.getElementById("schoolLogo").src = student.schoolLogo || "";
  document.getElementById("schoolName").innerText = student.schoolName || "";

  // Verification Icon
  document.getElementById("verifyStatus").innerHTML =
    student.verified
      ? "✔ Verified"
      : "✘ Not Verified";

  // ========== Personal Info ==========
  document.getElementById("passport").src = student.passport || "";
  document.getElementById("fullName").innerText = `${student.surname} ${student.firstname} ${student.middlename}`;
  document.getElementById("matricNo").innerText = student.matricNo;
  document.getElementById("department").innerText = student.department;
  document.getElementById("level").innerText = student.level;
  document.getElementById("email").innerText = student.email;
  document.getElementById("phone").innerText = student.phone;
  document.getElementById("stateOrigin").innerText = student.stateOrigin;
  document.getElementById("address").innerText = student.address;

  // ========== Next of Kin ==========
  document.getElementById("nokName").innerText = `${student.nokSurname} ${student.nokFirstname}`;
  document.getElementById("nokPhone").innerText = student.nokPhone || "N/A";
  document.getElementById("nokRelation").innerText = student.nokRelation || "N/A";
  document.getElementById("nokAddress").innerText = student.nokAddress || "N/A";

  // ========== Documents ==========
  const docDiv = document.getElementById("documentsList");
  if (student.documents && student.documents.length) {
    student.documents.forEach(doc => {
      const el = document.createElement("p");
      el.innerHTML = `<b>${doc.name}:</b> <a href="${doc.url}" target="_blank">${doc.url}</a>`;
      docDiv.appendChild(el);
    });
  } else {
    docDiv.innerHTML = "<p>No documents uploaded</p>";
  }

  // ========== OLEVEL IMAGES ==========
  async function fetchOlevelImages(matricNumber) {
    let olevelImages = [];
    try {
      const res = await fetch(`${backendURL}/api/olevel/${encodeURIComponent(matricNumber)}`);
      if (!res.ok) return [];
      const data = await res.json();
      if (data.success && Array.isArray(data.record)) {
        olevelImages = data.record
          .flatMap(r => r.olevelData.map(d => d.fileUrl))
          .filter(url => url && url !== "N/A");
      }
    } catch (err) {
      console.error("O'Level error:", err);
    }
    return olevelImages;
  }

  const oLevelImages = await fetchOlevelImages(student.matricNo);
  const oDiv = document.getElementById("olevelImages");

  if (oLevelImages.length) {
    oLevelImages.forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      img.style.width = "250px";
      img.style.margin = "10px 0";
      img.style.border = "1px solid #000";
      oDiv.appendChild(img);
    });
  } else {
    oDiv.innerHTML = "<p>No O'Level images found</p>";
  }

  // ========== Results ==========
  const res2 = await fetch(`${backendURL}/api/results/${student.matricNo}`);
  const resultsData = await res2.json();

  const rDiv = document.getElementById("resultsList");
  if (resultsData.success && resultsData.results.length) {
    resultsData.results.forEach(r => {
      const p = document.createElement("p");
      p.innerHTML = `<b>${r.courseCode}</b> - ${r.courseTitle}: ${r.score}`;
      rDiv.appendChild(p);
    });
  } else {
    rDiv.innerHTML = "<p>No results available</p>";
  }
}

loadStudent();


// ========== PDF GENERATION ==========
async function downloadPDF() {
  const element = document.getElementById("pdfContent");
  const canvas = await html2canvas(element, { scale: 2 });
  const imgData = canvas.toDataURL("image/png");

  const pdf = new jspdf.jsPDF("p", "mm", "a4");
  const width = pdf.internal.pageSize.getWidth();
  const height = (canvas.height * width) / canvas.width;

  pdf.addImage(imgData, "PNG", 0, 0, width, height);

  pdf.save("student-info.pdf");
}

</script>

</body>
</html>