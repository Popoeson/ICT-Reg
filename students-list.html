<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | ICT Registration Portal</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #007bff;
      color: #333;
      min-height: 100vh;
    }

    header {
      background: #0056b3;
      color: white;
      padding: 15px 25px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .container {
      max-width: 1000px;
      margin: 30px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
      padding: 20px;
    }

    .filter-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      border: 1px solid #e0e0e0;
      overflow: hidden;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      transition: all 0.3s ease;
    }

    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      font-weight: 600;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      user-select: none;
    }

    .filter-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 15px;
      background: #f9f9f9;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.5s ease, opacity 0.5s ease;
    }

    .filter-body.open {
      max-height: 400px;
      opacity: 1;
    }

    .filter-body input,
    .filter-body select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 0.95rem;
      background: #fff;
    }

    #clearFilters {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      width: 100%;
      transition: background 0.3s ease;
    }

    #clearFilters:hover {
      background: #c82333;
    }

    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .student-card {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      cursor: pointer;
    }

    .student-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }

    .passport {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
      border: 2px solid #007bff;
    }

    .fullname {
      font-weight: 600;
      color: #007bff;
      margin-bottom: 6px;
    }

    .serial {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 13px;
      background: #007bff;
      color: white;
      padding: 2px 8px;
      border-radius: 6px;
    }

    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 8px;
      transition: background 0.3s ease;
    }

    .delete-btn:hover {
      background: #b52a37;
    }

    @media (max-width: 600px) {
  .student-grid {
    grid-template-columns: repeat(2, 1fr); /* two cards per row */
    gap: 10px;
  }

  .student-card {
    padding: 10px; /* slightly smaller padding */
  }

  .passport {
    width: 60px;
    height: 60px;
  }

  .fullname {
    font-size: 0.9rem;
  }

  .serial {
    font-size: 11px;
    padding: 2px 6px;
  }

  .delete-btn {
    font-size: 0.75rem;
    padding: 4px 8px;
  }
}
  </style>
</head>
<body>

  <header>üìä Admin Dashboard</header>

  <div class="container">
    <!-- Collapsible Filter Section -->
    <div class="filter-card">
      <div class="filter-header" id="filterToggle">
        <span>üîç Filter & Search Students</span>
        <span id="toggleIcon">‚ñæ</span>
      </div>

      <div class="filter-body" id="filterBody">
        <input type="text" id="searchInput" placeholder="Search by name or matric number">

        <select id="departmentFilter">
          <option value="">All Departments</option>
          <option value="Computer Science">Computer Science</option>
          <option value="Computer Engineering">Computer Engineering</option>
          <option value="Business Admin">Business Admin</option>
          <option value="Science Lab Tech">Science Lab Tech</option>
          <option value="Estate Management">Estate Management</option>
          <option value="Accountancy">Accountancy</option>
          <option value="Mass Communication">Mass Communication</option>
          <option value="Electrical Engineering">Electrical Engineering</option>
          <option value="Medical Lab Tech">Medical Lab Tech</option>
        </select>

        <select id="levelFilter">
          <option value="">All Levels</option>
          <option value="ND1">ND 1</option>
          <option value="ND2">ND 2</option>
          <option value="HND1">HND 1</option>
          <option value="HND2">HND 2</option>
        </select>

        <button id="clearFilters">Clear Filters</button>
      </div>
    </div>

    <!-- Student Cards -->
    <div id="studentGrid" class="student-grid">
      <p style="text-align:center;">Loading students...</p>
    </div>
  </div>

  <script>
const backendBaseUrl = "https://ict-reg.onrender.com";
const studentGrid = document.getElementById("studentGrid");
const filterToggle = document.getElementById("filterToggle");
const filterBody = document.getElementById("filterBody");
const toggleIcon = document.getElementById("toggleIcon");

// Admin session info
const adminName = localStorage.getItem("adminName");
const adminRole = localStorage.getItem("adminRole");
const adminDepartment = localStorage.getItem("adminDepartment");

// Redirect if not logged in
if (!adminName || !adminRole) {
  window.location.href = "login.html";
}

const isSuperAdmin = adminRole.toLowerCase().includes("super");

// üîπ If ordinary admin ‚Üí lock department filter
const departmentSelect = document.getElementById("departmentFilter");
if (!isSuperAdmin && adminDepartment) {
  departmentSelect.value = adminDepartment;
  departmentSelect.disabled = true;
}

// Toggle filter animation
filterToggle.addEventListener("click", () => {
  filterBody.classList.toggle("open");
  toggleIcon.textContent = filterBody.classList.contains("open") ? "‚ñ¥" : "‚ñæ";
});

async function fetchStudents() {
  const q = document.getElementById("searchInput").value.trim();
  const department = isSuperAdmin
    ? document.getElementById("departmentFilter").value
    : adminDepartment; // force admin's department
  const level = document.getElementById("levelFilter").value;

  const queryParams = new URLSearchParams({ q, department, level });

  try {
    const res = await fetch(`${backendBaseUrl}/api/students?${queryParams}`);
    const data = await res.json();

    if (!data.success || !data.data || data.data.length === 0) {
      studentGrid.innerHTML = `<p style="text-align:center;">No students found</p>`;
      return;
    }

    // üîπ Apply client-side department filter for safety
    let filteredStudents = data.data;
    if (!isSuperAdmin && adminDepartment) {
      filteredStudents = filteredStudents.filter(
        (s) =>
          s.department?.toLowerCase().trim() ===
          adminDepartment.toLowerCase().trim()
      );
    }

    if (filteredStudents.length === 0) {
      studentGrid.innerHTML = `<p style="text-align:center;">No students found for your department.</p>`;
      return;
    }

    studentGrid.innerHTML = filteredStudents
      .map((s, index) => {
        const fullName = [s.surname, s.firstname, s.middlename]
          .filter(Boolean)
          .join(" ");

        // Add verified tick badge if student is verified
        const verifiedBadge = s.verified
          ? `<span style="
               position: absolute;
               top: 8px;
               right: 8px;
               width: 22px;
               height: 22px;
               background: green;
               color: white;
               font-size: 16px;
               display: flex;
               align-items: center;
               justify-content: center;
               border-radius: 50%;
               z-index: 10;
             ">‚úî</span>`
          : "";

        return `
          <div class="student-card" onclick="viewStudent('${s._id}')">
            <span class="serial">#${index + 1}</span>
            ${verifiedBadge}
            <img src="${s.passport || 'https://via.placeholder.com/70'}" class="passport" alt="passport"/>
            <div class="fullname">${fullName || "N/A"}</div>
            <div>${s.matricNo || "N/A"}</div>
            <div style="font-size:13px; color:#666;">${s.department || "N/A"} ‚Ä¢ ${s.level || "N/A"}</div>
            <button class="delete-btn" onclick="event.stopPropagation(); deleteStudent('${s._id}')">Delete</button>
          </div>
        `;
      })
      .join("");
  } catch (err) {
    console.error("Error fetching students:", err);
    studentGrid.innerHTML = `<p style="text-align:center;color:red;">Error loading students</p>`;
  }
}

// Redirect to student-info.html
function viewStudent(id) {
  window.location.href = `student-info.html?id=${id}`;
}

// Delete student
async function deleteStudent(id) {
  if (!confirm("Are you sure you want to delete this student?")) return;
  try {
    const res = await fetch(`${backendBaseUrl}/api/students/${id}`, { method: "DELETE" });
    const data = await res.json();
    if (data.success) {
      alert("Student deleted successfully!");
      fetchStudents();
    } else {
      alert("Failed to delete student.");
    }
  } catch (err) {
    console.error("Delete error:", err);
    alert("An error occurred while deleting student.");
  }
}

// Filter events
document.getElementById("searchInput").addEventListener("input", fetchStudents);
document.getElementById("departmentFilter").addEventListener("change", fetchStudents);
document.getElementById("levelFilter").addEventListener("change", fetchStudents);
document.getElementById("clearFilters").addEventListener("click", () => {
  document.getElementById("searchInput").value = "";
  if (isSuperAdmin) {
    document.getElementById("departmentFilter").value = "";
  }
  document.getElementById("levelFilter").value = "";
  fetchStudents();
});

// Initial fetch
fetchStudents();
</script>
</body>
</html>