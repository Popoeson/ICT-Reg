<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Registered Courses</title>
  <style>
    :root{
      --primary: #007bff;
      --bg: #f5f7fa;
      --card: #fff;
      --muted: #6c757d;
      --danger: #dc3545;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#222}
    header{background:var(--primary);color:#fff;padding:18px 16px;font-weight:700;text-align:center}
    .container{max-width:1200px;margin:22px auto;padding:18px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .controls .left, .controls .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"], select{padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff}
    button{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    button.danger{background:var(--danger);border:none}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .meta{font-size:0.95rem;color:var(--muted);margin-bottom:8px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th, td{padding:10px;border-bottom:1px solid #eef;text-align:left;font-size:0.95rem}
    th{background:#f8fbff;color:#0b3c8c;position:sticky;top:0}
    tr:hover td{background:#fbfdff}
    .small{font-size:0.85rem;padding:6px 8px;border-radius:6px}
    .badge{background:#eef6ff;color:var(--primary);padding:4px 8px;border-radius:999px;font-weight:600}
    .muted{color:var(--muted)}
    .table-wrap{overflow:auto;max-height:60vh;border-radius:8px}
    .empty{padding:28px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <header>Admin — Registered Courses</header>

  <div class="container">
    <div class="controls">
      <div class="left">
        <input id="searchBox" type="text" placeholder="Search by matric, name, course code or title..." style="min-width:320px" />

        <!-- Department filter will be hidden for Admin automatically -->
        <select id="filterDept">
          <option value="">All Departments</option>
          <option>Accountancy</option>
          <option>Business Admin</option>
          <option>Computer Science</option>
          <option>Computer Engineering</option>
          <option>Electrical Engineering</option>
          <option>Mass Communication</option>
          <option>Science Lab Tech</option>
          <option>OTM</option>
        </select>

        <select id="filterLevel">
          <option value="">All Levels</option>
          <option>ND1</option>
          <option>ND2</option>
          <option>HND1</option>
          <option>HND2</option>
        </select>

        <select id="filterSemester">
          <option value="">All Semesters</option>
          <option value="1">Semester 1</option>
          <option value="2">Semester 2</option>
        </select>

        <button id="clearFilters" class="ghost small">Clear</button>
      </div>

      <div class="right" style="margin-left:auto">
        <div class="meta">
          <span class="muted">Showing</span> <span id="visibleCount" class="badge">0</span>
          <span class="muted">of</span> <span id="totalCount" class="muted">0</span>
        </div>

        <button id="exportCsv" class="ghost small">Export CSV</button>
        <button id="refreshBtn" class="ghost small">Refresh</button>
        <button id="deleteAllBtn" class="danger small">Delete All</button>
      </div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table id="regTable">
          <thead>
            <tr>
              <th>Course Code</th>
              <th>Course Title</th>
              <th>Matric No.</th>
              <th>Student Name</th>
              <th>Level</th>
              <th>Department</th>
              <th>Semester</th>
              <th>Registered At</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="regTbody">
            <tr><td colspan="9" class="empty">Loading registered courses…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>


<script>
(() => {
  const backendBase = "https://ict-reg.onrender.com";
  const endpoint = "/api/admin/all-registered-courses";

  // Get admin data the CORRECT way based on your login page
  const adminRole = (localStorage.getItem("adminRole") || "").trim();
  const adminDept = (localStorage.getItem("adminDepartment") || "").trim();

  // Hide Department filter if Admin (NOT Super Admin, NOT Head Admin)
  if (["Admin", "Cashier"].includes(adminRole)) {
    document.getElementById("filterDept").style.display = "none";
  }

  // Hide delete-all button for Head Admin
  if (adminRole === "Head Admin") {
    document.getElementById("deleteAllBtn").style.display = "none";
  }

  // UI elements
  const searchBox = document.getElementById("searchBox");
  const filterDept = document.getElementById("filterDept");
  const filterLevel = document.getElementById("filterLevel");
  const filterSemester = document.getElementById("filterSemester");
  const clearFiltersBtn = document.getElementById("clearFilters");
  const refreshBtn = document.getElementById("refreshBtn");
  const exportCsvBtn = document.getElementById("exportCsv");
  const visibleCountEl = document.getElementById("visibleCount");
  const totalCountEl = document.getElementById("totalCount");
  const regTbody = document.getElementById("regTbody");
  const deleteAllBtn = document.getElementById("deleteAllBtn");

  let allRegs = [];
  let filtered = [];

  // Normalize data
  function normalize(item) {
    return {
      id: item._id,
      matric: item.matricNumber,
      studentName: item.studentName,
      courseCode: item.courseCode,
      courseTitle: item.courseTitle,
      level: item.level,
      department: item.department,
      semester: item.semester,
      createdAt: item.registeredAt
    };
  }

  // Fetch registered courses
  async function fetchRegistrations() {
    regTbody.innerHTML =
      `<tr><td colspan="9" class="empty">Loading registered courses…</td></tr>`;

    try {
      const res = await fetch(backendBase + endpoint);
      const payload = await res.json();

      let data = payload.data.map(normalize);

      // Admin must ONLY see their department
      if (["Admin", "Cashier"].includes(adminRole)) {
        data = data.filter(r => r.department.toLowerCase() === adminDept.toLowerCase());
      }

      // Head Admin & Super Admin see all

      allRegs = data;
      totalCountEl.textContent = allRegs.length;

      applyFilters();
    } catch (err) {
      regTbody.innerHTML =
        `<tr><td colspan="9" class="empty">Error loading data</td></tr>`;
    }
  }

  // Filters
  function applyFilters() {
    const q = searchBox.value.toLowerCase();
    const dept = filterDept.value.toLowerCase();
    const level = filterLevel.value;
    const sem = filterSemester.value;

    filtered = allRegs.filter(r => {
      if (dept && r.department.toLowerCase() !== dept) return false;
      if (level && r.level !== level) return false;
      if (sem && String(r.semester) !== sem) return false;

      return (
        r.matric.toLowerCase().includes(q) ||
        r.studentName.toLowerCase().includes(q) ||
        r.courseCode.toLowerCase().includes(q) ||
        r.courseTitle.toLowerCase().includes(q)
      );
    });

    renderTable();
  }

  // Render table
  function renderTable() {
    if (!filtered.length) {
      regTbody.innerHTML =
        `<tr><td colspan="9" class="empty">No registrations found.</td></tr>`;
      visibleCountEl.textContent = 0;
      return;
    }

    visibleCountEl.textContent = filtered.length;

    regTbody.innerHTML = filtered
      .map(r => {
        return `
        <tr data-id="${r.id}">
          <td>${r.courseCode}</td>
          <td>${r.courseTitle}</td>
          <td>${r.matric}</td>
          <td>${r.studentName}</td>
          <td>${r.level}</td>
          <td>${r.department}</td>
          <td>${r.semester}</td>
          <td>${new Date(r.createdAt).toLocaleString()}</td>

          <td>
            <button class="ghost small" data-action="view" data-id="${r.id}">View</button>

            ${
              adminRole !== "Head Admin"
                ? `<button class="danger small" data-action="delete" data-id="${r.id}">Delete</button>`
                : ""
            }
          </td>
        </tr>`;
      })
      .join("");
  }

  // Delete One
  async function deleteReg(id) {
    if (!confirm("Delete this registration?")) return;

    const res = await fetch(`${backendBase}/api/course-registrations/${id}`, {
      method: "DELETE"
    });

    const json = await res.json();
    if (json.success) {
      allRegs = allRegs.filter(r => r.id !== id);
      applyFilters();
      alert("Deleted!");
    }
  }

  // Delete All
  deleteAllBtn.addEventListener("click", async () => {
    if (!confirm("Delete ALL registrations?")) return;

    const res = await fetch(`${backendBase}/api/course-registrations`, {
      method: "DELETE"
    });

    const json = await res.json();
    if (json.success) {
      alert("All deleted!");
      fetchRegistrations();
    }
  });

  // Events
  searchBox.addEventListener("input", applyFilters);
  filterDept.addEventListener("change", applyFilters);
  filterLevel.addEventListener("change", applyFilters);
  filterSemester.addEventListener("change", applyFilters);

  clearFiltersBtn.addEventListener("click", () => {
    searchBox.value = "";
    filterDept.value = "";
    filterLevel.value = "";
    filterSemester.value = "";
    applyFilters();
  });

  document.addEventListener("click", e => {
    const btn = e.target.closest("button");
    if (!btn) return;

    const id = btn.dataset.id;
    if (btn.dataset.action === "delete") deleteReg(id);
  });

  // Load data
  fetchRegistrations();
})();
</script>
</body>
</html>