<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Registered Courses</title>
  <style>
    :root{
      --primary: #007bff;
      --bg: #f5f7fa;
      --card: #fff;
      --muted: #6c757d;
      --danger: #dc3545;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#222}
    header{background:var(--primary);color:#fff;padding:18px 16px;font-weight:700;text-align:center}
    .container{max-width:1200px;margin:22px auto;padding:18px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .controls .left, .controls .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"], select{padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff}
    button{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    button.danger{background:var(--danger);border:none}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .meta{font-size:0.95rem;color:var(--muted);margin-bottom:8px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th, td{padding:10px;border-bottom:1px solid #eef;text-align:left;font-size:0.95rem}
    th{background:#f8fbff;color:#0b3c8c;position:sticky;top:0}
    tr:hover td{background:#fbfdff}
    .small{font-size:0.85rem;padding:6px 8px;border-radius:6px}
    .badge{background:#eef6ff;color:var(--primary);padding:4px 8px;border-radius:999px;font-weight:600}
    .muted{color:var(--muted)}
    .table-wrap{overflow:auto;max-height:60vh;border-radius:8px}
    .empty{padding:28px;text-align:center;color:var(--muted)}
    @media(max-width:900px){
      .controls{flex-direction:column;align-items:stretch}
      th, td{font-size:0.9rem}
    }
  </style>
</head>
<body>
  <header>Admin — Registered Courses</header>

  <div class="container">
    <div class="controls">
      <div class="left">
        <input id="searchBox" type="text" placeholder="Search by matric, name, course code or title..." style="min-width:320px" />
        <select id="filterDept">
          <option value="">All Departments</option>
          <option>Accountancy</option>
          <option>Business Admin</option>
          <option>Computer Science</option>
          <option>Computer Engineering</option>
          <option>Electrical Engineering</option>
          <option>Mass Communication</option>
          <option>Science Lab Tech</option>
          <option>OTM</option>
        </select>

        <select id="filterLevel">
          <option value="">All Levels</option>
          <option>ND1</option>
          <option>ND2</option>
          <option>HND1</option>
          <option>HND2</option>
        </select>

        <select id="filterSemester">
          <option value="">All Semesters</option>
          <option value="1">Semester 1</option>
          <option value="2">Semester 2</option>
        </select>

        <button id="clearFilters" class="ghost small">Clear</button>
      </div>

      <div class="right" style="margin-left:auto">
        <div class="meta"><span class="muted">Showing</span> <span id="visibleCount" class="badge">0</span> <span class="muted">of</span> <span id="totalCount" class="muted">0</span></div>
        <button id="exportCsv" class="ghost small">Export CSV</button>
        <button id="refreshBtn" class="ghost small">Refresh</button>
<button id="deleteAllBtn" class="danger small">Delete All</button>
      </div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table id="regTable" role="grid" aria-busy="false">
          <thead>
            <tr>
              <th style="min-width:130px">Course Code</th>
              <th style="min-width:220px">Course Title</th>
              <th style="min-width:140px">Matric No.</th>
              <th style="min-width:200px">Student Name</th>
              <th style="min-width:80px">Level</th>
              <th style="min-width:160px">Department</th>
              <th style="min-width:80px">Semester</th>
              <th style="min-width:150px">Registered At</th>
              <th style="min-width:120px">Action</th>
            </tr>
          </thead>
          <tbody id="regTbody">
            <tr><td colspan="9" class="empty">Loading registered courses…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  const backendBase = "https://ict-reg.onrender.com";
  const endpoint = "/api/admin/all-registered-courses";

  // ============================
  //   GET LOGGED-IN ADMIN DATA
  // ============================
  const adminData = JSON.parse(localStorage.getItem("adminData") || "{}");
  const adminRole = adminData.role || "";
  const adminDept = adminData.department || "";

  // ============================
  //   UI ELEMENTS
  // ============================
  const searchBox = document.getElementById("searchBox");
  const filterDept = document.getElementById("filterDept");
  const filterLevel = document.getElementById("filterLevel");
  const filterSemester = document.getElementById("filterSemester");
  const clearFiltersBtn = document.getElementById("clearFilters");
  const refreshBtn = document.getElementById("refreshBtn");
  const exportCsvBtn = document.getElementById("exportCsv");
  const visibleCountEl = document.getElementById("visibleCount");
  const totalCountEl = document.getElementById("totalCount");
  const regTbody = document.getElementById("regTbody");
  const deleteAllBtn = document.getElementById("deleteAllBtn");

  let allRegs = [];
  let filtered = [];

  // Hide delete-all button for Head Admin
  if (adminRole === "Head Admin") {
    deleteAllBtn.style.display = "none";
  }

  // Debounce
  function debounce(fn, wait = 250) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }

  // Normalize server response
  function normalize(item) {
    return {
      id: item.id || item._id,
      matric: item.matricNumber || "",
      studentName: item.studentName || "",
      courseCode: item.courseCode || "",
      courseTitle: item.courseTitle || "",
      level: item.level || "",
      department: item.department || "",
      semester: item.semester || "",
      createdAt: item.registeredAt || item.createdAt || ""
    };
  }

  // ============================
  //   FETCH DATA
  // ============================
  async function fetchRegistrations() {
    regTbody.innerHTML =
      `<tr><td colspan="9" class="empty">Loading registered courses…</td></tr>`;

    try {
      const res = await fetch(backendBase + endpoint);
      if (!res.ok) throw new Error(`Status ${res.status}`);

      const payload = await res.json();
      if (!payload.success) throw new Error(payload.message);

      let data = (payload.data || []).map(normalize);

      // =============== ROLE-BASED FILTERING ===============
      if (adminRole === "Admin") {
        data = data.filter(item =>
          (item.department || "").toLowerCase() === adminDept.toLowerCase()
        );
      }
      // Super Admin & Head Admin see all

      allRegs = data;
      totalCountEl.textContent = allRegs.length;

      applyFilters();
    } catch (err) {
      console.error("Fetch error:", err);
      regTbody.innerHTML =
        `<tr><td colspan="9" class="empty">Error: ${err.message}</td></tr>`;
      visibleCountEl.textContent = 0;
      totalCountEl.textContent = 0;
    }
  }

  // ============================
  //   APPLY FILTERS
  // ============================
  function applyFilters() {
    const q = (searchBox.value || "").trim().toLowerCase();
    const dept = (filterDept.value || "").trim().toLowerCase();
    const level = (filterLevel.value || "").trim().toUpperCase();
    const sem = (filterSemester.value || "").trim();

    filtered = allRegs.filter(r => {
      if (dept && (r.department || "").toLowerCase() !== dept) return false;
      if (level && (r.level || "").toUpperCase() !== level) return false;
      if (sem && String(r.semester) !== sem) return false;

      if (!q) return true;

      return (
        (r.matric || "").toLowerCase().includes(q) ||
        (r.studentName || "").toLowerCase().includes(q) ||
        (r.courseCode || "").toLowerCase().includes(q) ||
        (r.courseTitle || "").toLowerCase().includes(q)
      );
    });

    renderTable();
  }

  // ============================
  //   RENDER TABLE
  // ============================
  function renderTable() {
    if (!filtered.length) {
      regTbody.innerHTML =
        `<tr><td colspan="9" class="empty">No registrations found.</td></tr>`;
      visibleCountEl.textContent = 0;
      return;
    }

    visibleCountEl.textContent = filtered.length;

    regTbody.innerHTML = filtered
      .map(item => {
        const created = item.createdAt
          ? new Date(item.createdAt).toLocaleString()
          : "-";

        return `
        <tr data-id="${item.id}">
          <td>${escapeHtml(item.courseCode)}</td>
          <td>${escapeHtml(item.courseTitle)}</td>
          <td>${escapeHtml(item.matric)}</td>
          <td>${escapeHtml(item.studentName)}</td>
          <td>${escapeHtml(item.level)}</td>
          <td>${escapeHtml(item.department)}</td>
          <td>${escapeHtml(item.semester)}</td>
          <td>${escapeHtml(created)}</td>
          <td>
            <button class="ghost small" data-action="view" data-id="${item.id}">View</button>

            ${
              adminRole !== "Head Admin"
                ? `<button class="danger small" data-action="delete" data-id="${item.id}">Delete</button>`
                : ""
            }
          </td>
        </tr>`;
      })
      .join("");
  }

  function escapeHtml(s = "") {
    return String(s).replace(/[&<>"]/g, c => {
      return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c];
    });
  }

  // ============================
  //   DELETE ONE
  // ============================
  async function deleteRegistration(id) {
    if (!confirm("Delete this registration?")) return;

    try {
      const res = await fetch(`${backendBase}/api/course-registrations/${id}`, {
        method: "DELETE"
      });

      const payload = await res.json();
      if (!payload.success) throw new Error(payload.message);

      allRegs = allRegs.filter(r => r.id !== id);
      applyFilters();
      alert("Deleted.");
    } catch (err) {
      alert("Error deleting: " + err.message);
    }
  }

  // ============================
  //   VIEW RECORD
  // ============================
  function viewRegistration(id) {
    const item = allRegs.find(r => r.id === id);
    if (!item) return;

    alert(
      `${item.courseCode} - ${item.courseTitle}\n` +
      `Student: ${item.studentName}\nMatric: ${item.matric}\n` +
      `Dept: ${item.department}\nLevel: ${item.level}\nSemester: ${item.semester}`
    );
  }

  // ============================
  //   EXPORT CSV
  // ============================
  function exportCSV() {
    if (!filtered.length) return alert("No rows to export.");

    const headers = [
      "Course Code",
      "Course Title",
      "Matric",
      "Student Name",
      "Level",
      "Department",
      "Semester",
      "Registered At"
    ];

    const rows = filtered.map(r => [
      r.courseCode,
      r.courseTitle,
      r.matric,
      r.studentName,
      r.level,
      r.department,
      r.semester,
      r.createdAt ? new Date(r.createdAt).toLocaleString() : ""
    ]);

    const csv =
      [headers, ...rows]
        .map(r =>
          r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")
        )
        .join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    a.href = url;
    a.download = `registered-courses-${new Date()
      .toISOString()
      .slice(0, 10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ============================
  //   DELETE ALL
  // ============================
  deleteAllBtn.addEventListener("click", async () => {
    if (!confirm("Delete ALL registrations?")) return;

    try {
      const res = await fetch(`${backendBase}/api/course-registrations`, {
        method: "DELETE"
      });

      const payload = await res.json();
      if (!payload.success) throw new Error(payload.message);

      alert(payload.message);
      fetchRegistrations();
    } catch (err) {
      alert("Error deleting all: " + err.message);
    }
  });

  // ============================
  //   EVENTS
  // ============================
  const debouncedApply = debounce(applyFilters, 200);

  searchBox.addEventListener("input", debouncedApply);
  filterDept.addEventListener("change", applyFilters);
  filterLevel.addEventListener("change", applyFilters);
  filterSemester.addEventListener("change", applyFilters);

  clearFiltersBtn.addEventListener("click", () => {
    searchBox.value = "";
    filterDept.value = "";
    filterLevel.value = "";
    filterSemester.value = "";
    applyFilters();
  });

  refreshBtn.addEventListener("click", fetchRegistrations);
  exportCsvBtn.addEventListener("click", exportCSV);

  document.addEventListener("click", ev => {
    const btn = ev.target.closest("button");
    if (!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;

    if (action === "delete") deleteRegistration(id);
    if (action === "view") viewRegistration(id);
  });

  // ============================
  //   INITIAL LOAD
  // ============================
  fetchRegistrations();
})();
</script>
</body>
</html>