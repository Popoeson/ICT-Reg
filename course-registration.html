<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Course Registration</title>
  <style>
    :root{
      --primary:#007bff;
      --muted:#6c757d;
      --bg:#f5f7fa;
      --card:#ffffff;
      --radius:10px;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#222}
    header{background:var(--primary);color:#fff;padding:16px;text-align:center;font-weight:700}
    .wrap{max-width:1100px;margin:22px auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h2{margin:0 0 12px 0;color:var(--primary)}
    .muted{color:var(--muted)}
    select, input[type=text]{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%}
    .course-row{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;border:1px solid #eef; margin-bottom:10px;background:#fbfdff}
    .course-info{flex:1}
    .course-code{font-weight:700;color:#0b5ed7}
    .course-title{font-size:0.95rem;color:#333;margin-top:4px}
    .course-meta{font-size:0.85rem;color:var(--muted);margin-top:6px}
    .actions{display:flex;gap:8px;align-items:center}
    button{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    button.small{padding:6px 8px;font-size:0.9rem}
    input.pin{width:130px;padding:8px;border-radius:8px;border:1px solid #ddd}
    .status{font-weight:700}
    .status-registered{color:#28a745}
    .status-not{color:#d9534f}
    .msg{padding:8px;border-radius:8px;margin-top:10px}
    .msg.success{background:#e6f4ea;color:#1b5e20}
    .msg.error{background:#fdecea;color:#991f00}
    .empty{padding:12px;text-align:center;color:var(--muted);border-radius:8px;border:1px dashed #ddd;background:#fafafa}
    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
      .course-row{flex-direction:column;align-items:flex-start}
      .actions{width:100%;justify-content:space-between}
      input.pin{width:100%}
    }
  </style>
</head>
<body>
  <header>Course Registration</header>

  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap">
      <div>
        <strong>Student:</strong> <span id="studentName">Loading...</span>
        &nbsp;|&nbsp;
        <strong>Matric:</strong> <span id="studentMatric">-</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="muted" style="margin-right:6px">Semester</label>
        <select id="filterSemester" style="min-width:140px;padding:8px;border-radius:8px;border:1px solid #ddd">
          <option value="">All</option>
          <option value="1">Semester 1</option>
          <option value="2">Semester 2</option>
        </select>
        <button id="refreshBtn" class="ghost small">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <!-- Available / Unregistered -->
      <div class="card">
        <h2>Available Courses <small class="muted" id="availCount"></small></h2>
        <div id="availableContainer">
          <div class="empty">Loading available courses…</div>
        </div>
      </div>

      <!-- Registered -->
      <div class="card">
        <h2>Registered Courses <small class="muted" id="regCount"></small></h2>
        <div id="registeredContainer">
          <div class="empty">Loading registered courses…</div>
        </div>
      </div>
    </div>

    <div id="feedback" style="margin-top:14px"></div>
  </div>

<script>
(async function(){

  const backendBaseUrl = "https://ict-reg.onrender.com";
  const urlParams = new URLSearchParams(window.location.search);
  const studentId = urlParams.get("id") || localStorage.getItem("studentId");

  if (!studentId) {
    document.getElementById("availableContainer").innerHTML =
      '<div class="empty">No student specified.</div>';
    return;
  }

  // UI refs
  const availableContainer = document.getElementById("availableContainer");
  const registeredContainer = document.getElementById("registeredContainer");
  const availCountEl = document.getElementById("availCount");
  const regCountEl = document.getElementById("regCount");
  const feedback = document.getElementById("feedback");
  const studentNameEl = document.getElementById("studentName");
  const studentMatricEl = document.getElementById("studentMatric");
  const filterSemesterEl = document.getElementById("filterSemester");
  const refreshBtn = document.getElementById("refreshBtn");

  // Cached
  let allCourses = [];
  let registered = [];
  let available = [];

  let studentDepartment = "";
  let studentLevel = "";

  // Load student
  async function loadStudent() {
    try {
      const res = await fetch(`${backendBaseUrl}/api/students/${studentId}`);
      const payload = await res.json();

      if (payload.success && payload.student) {
        const s = payload.student;
        studentDepartment = s.department?.trim() || "";
        studentLevel = s.level?.trim() || "";
        const fullname = [s.surname, s.firstname, s.middlename].filter(Boolean).join(" ");
        studentNameEl.textContent = fullname || "N/A";
        studentMatricEl.textContent = s.matricNo || s.regNo || "N/A";
      }
    } catch (err) {
      console.error("loadStudent err:", err);
    }
  }

  // Load and filter courses
  async function loadCourses() {
    try {
      const res = await fetch(`${backendBaseUrl}/api/courses`);
      const payload = await res.json();

      if (!payload.success || !Array.isArray(payload.data)) {
        allCourses = [];
        return;
      }

      const raw = payload.data;

      // Flatten:
      let flattened = [];
      raw.forEach(doc => {
        const { level, department, semester, courses } = doc;
        (courses || []).forEach(c => {
          flattened.push({
            code: (c.code || c.courseCode || "").trim(),
            title: (c.title || c.courseTitle || "").trim(),
            level: (level || "").trim(),
            department: (department || "").trim(),
            semester: Number(semester) || Number(c.semester) || null
          });
        });
      });

      // NOW FILTER by student department & level
      allCourses = flattened.filter(c =>
        c.department?.toLowerCase() === studentDepartment?.toLowerCase() &&
        c.level?.toLowerCase() === studentLevel?.toLowerCase()
      );

    } catch (err) {
      console.error("loadCourses error:", err);
      allCourses = [];
    }
  }

  // Load registered
  async function loadRegistered() {
    try {
      const res = await fetch(`${backendBaseUrl}/api/registrations/${studentId}`);
      const payload = await res.json();

      const regList =
        payload.registered ||
        payload.data?.registered ||
        payload.registeredCourses ||
        payload.data?.registeredCourses ||
        payload.data ||
        [];

      if (!Array.isArray(regList)) {
        registered = [];
        return;
      }

      registered = regList.map(item => ({
        code: (item.code || item.courseCode || "").trim(),
        title: (item.title || item.courseTitle || "").trim()
      }));

    } catch (err) {
      console.error("loadRegistered error:", err);
      registered = [];
    }
  }

  // Compute available (unregistered)
  function computeAvailable() {
    const regCodes = new Set(registered.map(r => r.code.toUpperCase()));
    const semFilter = filterSemesterEl.value;

    available = allCourses.filter(c => {
      if (semFilter && String(c.semester) !== semFilter) return false;
      return !regCodes.has(c.code.toUpperCase());
    });
  }

  // Render
  function render() {
    // Available
    if (!available.length) {
      availableContainer.innerHTML = `<div class="empty">No available courses</div>`;
      availCountEl.textContent = "";
    } else {
      availCountEl.textContent = `(${available.length})`;
      availableContainer.innerHTML = available.map(c => `
        <div class="course-row" data-code="${c.code}">
          <div class="course-info">
            <div class="course-code">${c.code}</div>
            <div class="course-title">${c.title}</div>
            <div class="course-meta">${c.department} · ${c.level} · Sem ${c.semester}</div>
          </div>
          <div class="actions">
            <input class="pin" placeholder="Enter pin" />
            <button class="registerBtn small" data-code="${c.code}">Register</button>
          </div>
        </div>
      `).join("");
    }

    // Registered
    if (!registered.length) {
      registeredContainer.innerHTML = `<div class="empty">No courses registered yet</div>`;
      regCountEl.textContent = "";
    } else {
      regCountEl.textContent = `(${registered.length})`;
      registeredContainer.innerHTML = registered.map(r => `
        <div class="course-row">
          <div class="course-info">
            <div class="course-code">${r.code}</div>
            <div class="course-title">${r.title}</div>
          </div>
          <div class="actions"><span class="status status-registered">Registered</span></div>
        </div>
      `).join("");
    }
  }

  // Register handler
  document.addEventListener("click", async ev => {
    const btn = ev.target.closest(".registerBtn");
    if (!btn) return;

    const code = btn.dataset.code;
    const row = btn.closest(".course-row");
    const pin = row.querySelector("input.pin").value.trim();
    if (!pin) return showMessage("Enter pin before registering", "error");

    btn.disabled = true;
    btn.textContent = "Checking...";

    try {
      const response = await fetch(`${backendBaseUrl}/api/course-registrations/register`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ studentId, courseCode: code, pin })
      });

      const data = await response.json();

      if (response.ok && data.success) {
        showMessage(`Successfully registered ${code}`, "success");
        await reloadAll();
      } else {
        showMessage(data.message || "Invalid or used pin", "error");
      }

    } catch (err) {
      console.error(err);
      showMessage("Server error during registration", "error");
    }

    btn.disabled = false;
    btn.textContent = "Register";
  });

  function showMessage(msg, type="success", timeout=3000) {
    feedback.innerHTML = `<div class="msg ${type === "success" ? "success":"error"}">${msg}</div>`;
    if (timeout) setTimeout(()=> feedback.innerHTML="", timeout);
  }

  async function reloadAll() {
    await loadStudent();
    await loadCourses();
    await loadRegistered();
    computeAvailable();
    render();
  }

  filterSemesterEl.addEventListener("change", () => {
    computeAvailable();
    render();
  });

  refreshBtn.addEventListener("click", reloadAll);

  await reloadAll();

})();
</script>
</body>
</html>