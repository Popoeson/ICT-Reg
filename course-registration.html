<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Course Registration</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f9ff;
        margin: 0;
        padding: 0;
    }

    header {
        background: #0b3c8c;
        color: white;
        padding: 18px;
        text-align: center;
        font-size: 22px;
        font-weight: bold;
    }

    .container {
        max-width: 900px;
        margin: 25px auto;
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h2 {
        color: #0b3c8c;
        margin-bottom: 10px;
    }

    .course-box {
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 12px;
        background: #f9fcff;
    }

    .registered {
        border-left: 6px solid #0bb30b;
        background: #eaffea;
    }

    .unregistered {
        border-left: 6px solid #d9534f;
        background: #fff3f3;
    }

    button {
        background: #0b3c8c;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }

    button:hover {
        background: #092d6b;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        inset: 0;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        padding: 20px;
        width: 320px;
        border-radius: 8px;
        text-align: center;
    }

    input {
        width: 90%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #0b3c8c;
        border-radius: 5px;
    }
</style>
</head>

<body>

<header>Course Registration</header>

<div class="container">
    <h2>Your Courses</h2>
    <div id="courseList">Loading courses...</div>
</div>

<!-- PIN MODAL -->
<div id="pinModal" class="modal">
    <div class="modal-content">
        <h3 style="color:#0b3c8c;">Enter Registration Pin</h3>
        <p id="modalCourse" style="font-weight:bold;"></p>

        <input type="text" id="pinInput" placeholder="Enter Pin Here" />

        <button onclick="submitPin()">Submit</button><br><br>
        <button style="background:#999;" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
let selectedCourse = null;

// Load student data
const student = JSON.parse(localStorage.getItem("studentData"));
if (!student) {
    alert("Session expired. Please login again.");
    window.location.href = "student-login.html";
}

const userDept  = student.department.toLowerCase().trim();
const userLevel = student.level.toUpperCase().replace(/\s+/g, '');


// Fetch courses + registered courses
async function loadCourses() {
    document.getElementById("courseList").innerHTML = "Loading...";

    try {
        const courseRes = await fetch(`https://ict-reg.onrender.com/api/courses?department=${userDept}&level=${userLevel}`);
        const courseData = await courseRes.json();

        const regRes = await fetch(`https://ict-reg.onrender.com/api/registered-courses?matric=${student.matricNumber}`);
        const regData = await regRes.json();

        const courses = courseData.courses || [];
        const registered = regData.data || [];

        displayCourses(courses, registered);
    } catch (err) {
        console.error(err);
        document.getElementById("courseList").innerHTML = "Error loading courses.";
    }
}

function displayCourses(courses, registered) {
    const container = document.getElementById("courseList");
    container.innerHTML = "";

    if (courses.length === 0) {
        container.innerHTML = `<p>No courses found for your level & department.</p>`;
        return;
    }

    courses.forEach(course => {
        const isReg = registered.some(r => r.courseCode === course.code);

        const div = document.createElement("div");
        div.className = "course-box " + (isReg ? "registered" : "unregistered");

        div.innerHTML = `
            <strong>${course.code} - ${course.title}</strong><br>
            Unit: ${course.unit}<br>
            Lecturer: ${course.lecturer}<br><br>
            ${isReg 
                ? `<span style="color:#0bb30b; font-weight:bold;">REGISTERED</span>` 
                : `<button onclick="openPinModal('${course.code}', '${course.title}')">Register</button>`
            }
        `;

        container.appendChild(div);
    });
}

// Modal functions
function openPinModal(code, title) {
    selectedCourse = { code, title };
    document.getElementById("modalCourse").innerText = `${code} - ${title}`;
    document.getElementById("pinModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("pinModal").style.display = "none";
    document.getElementById("pinInput").value = "";
}

async function submitPin() {
    const pin = document.getElementById("pinInput").value.trim();
    if (pin === "") return alert("Enter pin");

    const payload = {
        matricNumber: student.matricNumber,
        studentName: student.fullName,
        department: student.department,
        level: student.level,
        courseCode: selectedCourse.code,
        courseTitle: selectedCourse.title,
        pin
    };

    try {
        const res = await fetch("https://ict-reg.onrender.com/api/course-register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        alert(data.message);

        if (data.success) {
            closeModal();
            loadCourses(); // refresh page list
        }
    } catch (err) {
        console.error(err);
        alert("Error submitting pin");
    }
}

loadCourses();
</script>

</body>
</html>